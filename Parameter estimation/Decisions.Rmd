# Decisions {#decisions}
```{r, echo=FALSE, include=FALSE}
#-----------------------------------------------------------------------------------
# Load packages
#-----------------------------------------------------------------------------------
    library("tidyverse")
    library("knitr")
    library("kableExtra")
    options(knitr.table.format = "html") 
```

This file summarizes the decisions made about parameter estimation and model structure.

## Data from HIV-positive men
- Because the WHPP sample excluded men who had ever tested positive for HIV, we would ideally obtain corresponding data from HIV-positive men. However, existing data sources on HIV-positive MSM in Washington are limited: the Medical Monitoring Project does collect data on some variables, but it will really only inform estimates of mixing patterns by race/ethnicity and age, sex role, and disclosure at the outset of relationships; the NHBS also has some relevant variables, but the sample of HIV-positive men is small, limited to Seattle-area MSM, and it does not not measure anything on HIV-positive men that we cannot get from MMP. As such, we will use data from MMP on HIV-positive men where we can, use data from Atlanta-area studies where appropriate (e.g. for estimates of changes in condom use with diagnosis or disclosure), but we will otherwise assume estimates are the same for HIV-positive as HIV-negative/uknown status men who completed the WHPP survey. Some behaviors with negative men may change post-diagnosis (see Christine Khosropour's [2016 JAIDS paper on changes in serosorting](https://insights-ovid-com.offcampus.lib.washington.edu/pubmed?pmid=27792685)), such that future work should try to obtain more data from diagnosed HIV-positive men.

## Reweighting
- We decided to re-weight the WHPP sample to the joint population distribution of race and region and the marginal distribution of age (see section \@ref(reweight)). 
- For parameters that will be estimated specifically for HIV-negative and unknown-status men (i.e. we have data from another source to inform parameter values for HIV-positive men), reweight the sample to the population totals for HIV-negative/undiagnosed men. But for parameters estimated from the WHPP survey or other sources that will apply to all men (i.e. we don't have data from another source for HIV-positives so we will assume that the estimates do not differ by HIV status), reweight to the population totals for all men. Note that parameters estimated from data specific to HIV-positive men should only be applied to those who have been diagnosed.
- For some variables we have missing data, such that the sample reporting on those variables may not reflect the population distribution after reweighting the overall WHPP sample to the population totals. For now, we will assume that data are missing completely at random, such that this approach is appropriate.

## Using data from ongoing vs all partnerships
- We decided to use data only from ongoing partnerships to inform parameters relating to race and age mixing. This is because the formation model, to which these parameters are relevant, aims to recreate the network we observe at the cross-section. An issue is that the NHBS and MMP, datasets I will also be using to inform parameters, do not ask whether partnerships are ongoing. But we will just work with what we have.
- For parameters relating to condom use and coital frequency, we decided to use data from all partnerships. The analysis in section \@ref(coitfreq_condoms) revealed that, for all comparisons but coital frequency in persistent partnerships among Hispanic men, the estimates were comparable when using data from all vs. only ongoing partnerships. Because the sample sizes are considerably smaller when restricting to ongoing partnerships and there is not a good reason to do so, we decided to use data from all partnerships.

## Using data on most recent partners
- In analyses comparing the characteristics of most recent partners by momentary degree (i.e. comparing main most recent partners described by men with 0 vs. 1+ ongoing persistent partner and comparing persistent most recent partners described by men with 0 vs. 1 ongoing main partners) (\@ref(mrp_limitations)), no significant differences were observed. This suggests that it is appropriate to use data reported on all ongoing partners of a given type to impute the characteristics (implicitly or explicitly) of other ongoing partners who were not reported on as the most recent partner.

##Racial/ethnic groups
- We decided to represent racial/ethnic heterogeneity by defining three groups: Hispanic, non-Hispanic black (including men who reported black race alone or in combination with another race), and non-Hispanic other (including men who listed any other non-Hispanic race). See section \@ref(composition) for more details on this decision.

## Age range
- Although the age range for the WHPP sample spanned ages 16-82, other sources from which we might want to estimate parameters (e.g. the Medical Monitoring Project) have a minimum age of 18. As such, we defined the minimum age for the modeled population to be 18. We set the maximum age for the network model to be 59 based on data showing that 1/3 of PrEP users are above the age of 40, such that expanding th emodel into older ages would be important (see section \@ref(composition)).
- We also decided to restrict alter ages to 18-59. Data on most recent partners who were under age 18 (n=18) or over age 59 (n=13) were excluded from calculation of partner-specific parameters (e.g. age and race mixing, coital frequency, condom use, partnership age). Egos who reported partners out of the age range were retained in the network for estimation of other parameters, and the out-of-range partnerships were still counted in calculation of mean degree. We found that men who reported partners outside of the age range differed in several ways from men who reported partners in the age range (section \@ref(alter_age_boundary). Future modeling work may want to explore different ways to represent these out-of-network partnerships, such as with a heat bath.

## Age structure
- Previous MSM network models have defined a relatively flat age structure for the tarting network, and allowed it to be modified by mortality without taking any steps to preserve a target age distribution. For this model, because we have a wider age range and we are weighting the sample to match the population distribution by age for Washington males, we would want to try to specify and preserve that age distribution in the absence of disease so that we know how to interpret changes due to disease processes. Although we don't know the "true" age distribution for MSM, we could start by specifying the age distriubtion for males in Washington. Then we specify entry and migration rates to balance mortality and preserve the distribution. Proposed approach:
  - Because the population age distribution looks relatively flat, specify re-entry at age 18 to balance background mortality and aging out of the model (see [issue #29](https://github.com/statnet/WHAMP/issues/29)). __Do not__ try to balance HIV-related mortality because we want to preserve the age distribution _in the absence of_ HIV. For now, don't worry about population growth; preserve the network size. But at a later point, we could adjust the entry rates so that the population grows at a rate corresponding to observed population growth for males (with the assumption that the growth rate for MSM is similar).
  - See if a model specified in this way reproduces the observed age distribution over time. If not, consider specifying entry to the network as a combination of "births" at age 18 and entry from migration at older ages. We would need to decide whether these migrants are using PrEP or HIV-positive (i.e. could assign a probability of entering with HIV based on the starting prevalence, and could assume noone who enters is using PrEP, but at the next time step they could be evaluated for PrEP candidacy. This seems like a reasonable assumption b/c someone coming in from out of state would need to establish care with an in-state provider to continue being on PrEP).

## Region
- To represent heterogeneity by region, we categorized men into three regions based on their reported zip codes: King County, other western Washington, eastern Washington (see \@ref(composition)). 
- We do not have data on patterns of sexual mixing by region, so we will specify different patterns in sensitivity analyses (i.e. entirely homophilous and allowing for some crosss-regional mixing). For simplicity, we will use `nodematch` for regional mixing and assume that mixing with the off-diagonal elements occurs with equal probability. While there is reason to believe that these off-diagonals would be different, we don't have data to inform this and would need to make more assumptions. For main partnerships, we will assume that all partnerships are within-region. For persistent partnerships, there is an argument to be made that there would be more cross-regional mixing than with instantaneous partners (e.g. the reason the partnership is persistent and not main is that it is cross-region), but there is also an argument to be made that instantaneous would be more likely to be cross-region if these partnerships occur when men are traveling or out in the city for the night. For the base model, we will assume the degree of mixing is the same for both of these partnership types, and we will run it as a sensitivity parameter with values of 0.7, 0.8, and 0.9 for the degree of homophily (see [issue #32](https://github.com/statnet/WHAMP/issues/32)).

## Momentary degree (partnership formation)
- Main partnership status: The probability of having an ongoing main partner appears to differ by race/ethnicity and region (\@ref(explore_heterogeneity)), so we will include main effect terms for race/ethnicity and region in model code relating to main partner degree.
- Persistent partnership status: The probabilities of having any persistent partners, concurrent persistent partners, and having a persistent partner concurrent with a main partner were all higher for men aged 40-49. As such, we will code the model to define separate probabilities for men aged 40-49 of forming a persistent partnership, having concurrent persistent partnerships, and having a persistent partnership concurrent with a main partnership. However, because this pattern by age doesn’t align with our understanding of MSM’s sexual behavior, in the base model we will set this probability to be the same as for men of other ages. We will run sensitivity analyses in which we define a higher probability for men aged 40 to 49.  

## Rate of instantaneous partners
- We will code the model to represent heterogeneity in the rate of instantantous partnerships by assigning men into one of four categories based on the quartile distribution of the rate of instantaneous partnerships. Fitting with the strategy implemented in the current code, I will assume that each quartile is of equal size, such that the bottom quartile will include the lowest 25% of the sample, the next quartile will contain the next 25%, and so on. This will mean that some men with the same reported rate will be split across quartiles. By age, there appears to be an increased probability of having zero instantaneous partnerships after age 50 (\@ref(plots_explore_rateinst_3)). 
  As such, we will assign the quartile bins separately for men aged 18-49 and men aged 50+. Within each bin, we will calculate the mean rate of instantaneous partnerships for men below 50 and for men 50+ (i.e. define two vectors for the mean rate wihtin quartiles for men aged 18-49 and the mean rate within quartiles for men aged 50+). In the formation model, we will specify `nodefactor("qnt", "over49")`, where "qnt" is an attribute indicating which quartile individuals belong to and "over49" is an indicator variable for whether someone is under 50 or 50+. This code will take the interaction between the two as the nodefactor term, and the target statistic will be the number of partnerships for each quantile by age based on the age- and quartile-specific rates of instantaneous partnerships. Note that this approach does not require specification of a transition matrix to move people from one quartile to the other with age, as initially planned. Instead it will just define different rates for the quartiles by age. See [issue #32](https://github.com/statnet/WHAMP/issues/32).
- In addition to age heterogeneity, the rate of instantaneous partnerships appears to differ by momentary degree (\@ref(fig:plotsexplore_rateinst_5)).We will define separate rates of instantaneous partnerships by the joint distribution of main and persistent (0 vs. 1+) partnership status. 

## Age mixing
- We will stratify age mixing by partner type.
- Age mixing appears to differ by ego age (see \@ref(explore_heterogeneity)), even after parameterizing it as the absolute difference in the square root of ego and later ages. However, this parameterization seems good enough, so we will not represent additional heterogeneity in age mixing by age.
- Age mixing did not appear to differ meaningfully by race/ethnicity (\@ref(fig:plots_explore_agemixing_4)) or region (\@ref(fig:plots_explore_agemixing_5)).

## Race mixing
- Exploratory analyses did not indicate differences in race mixing by age or region (see \@ref(explore_heterogeneity)). 
- Due to the small number of black men reporting ongoing partnerships of any type, we will collapse the off-diagonal elements and represent race mixing using a nodematch term. We will also collapse the persistent and instantaneous networks in calculation of sufficient statistics for race mixing. While neither of these approaches is ideal, they avoid putting too much weight on data from a very small number of respondents (in particular, 0 black men reported ongoing persistent partnerships with other black men). See section \@ref(mixing) for more detail and supporting tables.

## Partnership age
- Exploratory analyses (section \@ref(explore_heterogeneity) suggest that the age of main partnerships varies by age, but this is a complex phenomenon. For instance, the data are subject to censoring by age, in that the partnerships of younger men can only have persisted a relatively short time simply due to how long it has been since their presumed debut. We will not model heterogeneity in partnership duration by age at this point. 
- For target statistics, we will use the observed median ages of extant main and persistent partnerships to obtain the means assuming an exponential distribution (mean = median / ln(2)). While an exponential distribution does not provide a great fit for the observed data (section \@ref(duration)), assuming an exponential distribution is the only option with available methods. Note that compartmental models assume exponential (memoryless) distributions for all rates, whereas we are only making this assumption for one parameter. Future work is needed to identify alternative ways to parameterize duration without relying on this assumption.

## Anal sex role
- Although there is some indication that anal sex role differs by age and race/ethnicity, these patterns do not appear meaningful (see section \@ref(explore_heterogeneity)). Additionally, representing heterogeneity in anal sex role by these attributes introduces complexity into the model because it will affect balance in mixing. We have flagged this as something to explore in the future (section \@ref(future_explore)), but we will not stratify sex role by race/ethnicity or age in the current model.

## Network model formulas
- From the exploratory analyses, we will specify the following models for formation of main, persistent, and instantaneous partnerships (with acknowledgement that these models may need to be modified if we face convergence issues).
```{r formation_models, echo=FALSE}
formation.models <- cbind.data.frame("Partner type" = c("Main", "Persistent", "Instantaneous"), "Main effects" = c("edges; race/ethnicity; region", "edges; age 40-49 (in sensitivity analyses)", "edges; risk group"), "Mixing effects" = c("race/ethnicity (nodematch); absdiff sqrt of ego and alter ages", "race/ethnicity (nodematch); region (nodemix); absdiff sqrt of ego and alter ages", "nodematch race/ethnicity; nodemix region; absdiff square root of ego and alter ages"), "Dyad-dependent terms" = c("persistent degree (nodefactor)", "main degree (nodefactor); concurrent", "main/persistent degree (nodefactor)"), "Offsets" = c("role class (nodematch); regional mixing (nodemix to specify only same-region)", "role class (nodematch)", "role class (nodematch)"), "Constraints" = c("maximum degree of 1", "maximum degree of 2", ""))

kable(formation.models, col.names=c("Model", "Main effects", "Mixing effects", "Dyad-dependent terms", "Offsets", "Constraints")) %>% kable_styling(full_width= F, position="center") %>% column_spec(2:6, width = "26cm") 
```

## Proportion never tested for HIV
- To represent the proportion of men who do not test for HIV, we will use data on the proportion of men aged 40 and above who indicate that they've never tested. This was informed by examination of plots of the proportion of men who reported ever testing by age (section \@ref(hivtesting)). These plots indicate that the probability of having tested peaks around age 40, suggesting that if men don't test by this age they are unlikely to. Of course the data reflect a mix of age and cohort effects, but this provides a rough indication of the testing pattern in the population.
- The proportion of men who have not tested for HIV by age 40 appears to differ by region (section \@ref(explore_heterogeneity)). As such, we will stratify this parameter by region.

## Intertest interval
- We will model the intertest interval as an interval process, as this yields summary statistics that more closely match what we've seen in other sources (section \@ref(hivtesting)). With this assumption, the intertest interval is estimated as twice the time since the last test since the survey was not administered in connection with any testing event. The assumption is that the date of survey is randomly distributed throughout men's time between tests, such that on average it will come halfway through their intertest interval. We will use the median as the summary statistic, because for interval data that can be easily skewed by outliers, the median may be more stable. Additionally, using the median we get results that match what we've seen in other studies (see section \@ref(hivtesting)).
- For estimation of this parameter, we use data from men who did not report use of PrEP in the past 12 months, as we expect PrEP to change testing frequency and the model will represent the change in testing frequency with PrEP. While it is possible that men who are on PrEP tested more frequently before going on PrEP, for now we will just use data from men who had not used PrEP, though we will consider exploring ways to account for the pre-PrEP testing patterns of PrEP users in the future (see section \@ref(future_explore)).
- The intertest interval appears to vary by age (section \@ref(explore_heterogeneity)). To capture this heterogeneity, we will represent the intertest interval as a function of centered age and centered age squared.

## Coital frequency
- For data on coital frequency, we decided to drop data points from 4 men (3 of whom were in the age range 18-59) who reported having sex >=2 times per day and take the mean values as the summary statistics. 
- Exploratory analyses indicate that coital frequency differs significantly by region in main partnerships (section \@ref(explore_heterogeneity)). Since this is not an expected finding and doesn't make much intuitive sense, we will run the base model without stratifying by region. However, we will explore the impact of adding this regional heterogeneity in sensitivity analyses. 
- We use data from all dyads to estimate this parameter. The model code does not define a separate parameter for how this chagnes with HIV diagnosis and/or disclosure, we we assume the same rate for discordant dyads wherein the positive partner doesn't know or hasn't disclosed his status (for which we use negative/unknown status dyads as a proxy) and known discordant dyads. A caveat is that the WHPP sample doesn't include egos who have been diagnosed with HIV, so the estimates may not be reprentative of all dyads.
- Take the mean value for coital frequency

## Condom use
- Condom use in main partnerships appears to differ by age. In the model, we will stratify condom use with main partners by dyad age, using one degree of freedom to specify the higher rate in young-young (18-34) dyads relative to all other dyads.
- Condom use in persistent and instantaneous partnerships does not appear to differ meaningfully by age, or by any other attribute.
- A challenge with specifying condom use probabilities is that the WHPP survey asked about condom use with the most recent partner, making it difficult to disentangle individual condom use propensities from condom use in a given dyad, which is influenced by the propensities of both partners. Also, if we were able to identify individual propensities, we would need to figure out what to do if two people with different propensities for condom use mix. While the WHPP survey does ask respondents if they had any condomless anal sex in the past 12 months and any condomless anal sex with non-main/primary partners in the past 12 months, it is still a bit of a stretch to infer individual propensities from these data. As such, __for now we will define condom use parameters as the mean within partnership types (stratified by dyad age for main partnerships).__ A limitation of this approach is that it doesn't capture patterns of condom use whereby some men always use condoms and others never do. As such, we will flag this as an issue for future work to explore how to specify different individual-level propensities for condom use (e.g. never, sometimes, and always) and make assumptions about how these individual-level propensities shape condom use at the dyad level (see \@ref(future_explore)).

## PrEP use
- PrEP use among men for whom Washington guidelines recommend initiation or indicate discussion of PrEP with a provider differs in the sample by age and region. There is some suggestion of variabiltiy by race/ethnicity, but it is not very clear. However, we will code the model to represent the main effects of all three nodal attributes given the interest in disparities by race/ethnicity. We could explore the impact of graeter disparities in sensitivity analyses.

## Risk compensation with PrEP use
- There is evidence in the literature that PrEP use is associated with changes in condom use^[Oldenburg CE, Nunn AS, Montgomery M, Almonte A, Mena L, Patel RR, et al. Behavioral Changes Following Uptake of HIV Pre-exposure Prophylaxis Among Men Who Have Sex with Men in a Clinical Setting. AIDS and behavior. 2017; Lal L, Audsley J, Murphy DA, Fairley CK, Stoove M, Roth N, et al. Medication adherence, condom use and sexually transmitted infections in Australian preexposure prophylaxis users. AIDS (London, England). 2017;31(12):1709-14.; Newcomb ME, Moran K, Feinstein BA, Forscher E, Mustanski B. Pre-Exposure Prophylaxis (PrEP) Use and Condomless Anal Sex: Evidence of Risk Compensation in a Cohort of Young Men Who Have Sex with Men. JAIDS Journal of Acquired Immune Deficiency Syndromes. 2017;Publish Ahead of Print.], and some studies have reported changes in seroadaptive strategies such as positioning, the number of partners, and possibly coital frequency.^[Hughes AJ, Chen YH, Scheer S. Condomless Anal Sex Among HIV-Positive Men Who Have Sex with Men: Biomedical Context Matters. AIDS and behavior. 2017;21(10):2886-94; Lal L, Audsley J, Murphy DA, Fairley CK, Stoove M, Roth N, et al. Medication adherence, condom use and sexually transmitted infections in Australian preexposure prophylaxis users. AIDS (London, England). 2017;31(12):1709-14.; Newcomb ME, Moran K, Feinstein BA, Forscher E, Mustanski B. Pre-Exposure Prophylaxis (PrEP) Use and Condomless Anal Sex: Evidence of Risk Compensation in a Cohort of Young Men Who Have Sex with Men. JAIDS Journal of Acquired Immune Deficiency Syndromes. 2017;Publish Ahead of Print.]. We will start by assuming that condom use is the only thing to change with PrEP use, but consider building in other types of risk compensation as well. This would require re-estimating the parameters related to any behavior thought to change with PrEP to impute what the behaviors of PrEP users would be in the absence of PrEP. It might also be interesting to explore the possible impact of community-level risk compensation due to prevention optimism^[Holt M, Murphy DA. Individual Versus Community-Level Risk Compensation Following Preexposure Prophylaxis of HIV. American journal of public health. 2017:e1-e4.], but this could be tricky b/c the data from WHPP may already reflect some of this effect, so getting the counterfactual right would require some adjustments.

# Things to check against simulated data
- Make sure that the distribution of the age of partnerships by ego age produced by the model corresponds to the observed distributions (see \@ref(fig:plotsexplore_pshipage)).
- Check that the age structure in the absence of disease preserves the target age distribution for Washington males. If not, consider specifying entries to the model as both "births" at age 18 and as migration at later ages (see [issue #29](https://github.com/statnet/WHAMP/issues/29)).