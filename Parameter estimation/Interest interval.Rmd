# Intertest interval {#iti}

```{r, include=FALSE}
####################################################################################
# Setup
####################################################################################
#-----------------------------------------------------------------------------------
# Load packages
#-----------------------------------------------------------------------------------

    library("tidyverse")
    library("knitr")
    library("data.table")
    library("kableExtra")

#-----------------------------------------------------------------------------------
# Knitr options
#-----------------------------------------------------------------------------------
opts_chunk$set(echo=FALSE, message=FALSE, warning=TRUE, error=TRUE, fig.align = "center")
options(knitr.table.format = "html") 

#-----------------------------------------------------------------------------------
# Plot settings
#-----------------------------------------------------------------------------------
#save plot settings for white background and light grey lines and darkening the colors a bit
plot_background <- theme(panel.background = element_rect(fill="white", colour = "black")) + theme(panel.grid.major = element_line(colour = "grey90"))
darken_color <- scale_colour_hue(l=50)
theme_title <- theme(plot.title = element_text(hjust = 0.5, size=12)) 
        
#-----------------------------------------------------------------------------------
# Load data
#-----------------------------------------------------------------------------------

load(file="Data/InternetSurveySample.Rdata")
load(file="Data/InternetSurveySample_allages.Rdata")

#----------------------------------------------------------------------------------
# Define multiplot function
#_---------------------------------------------------------------------------------
        multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
            library(grid)
            
            # Make a list from the ... arguments and plotlist
            plots <- c(list(...), plotlist)
            
            numPlots = length(plots)
            
            # If layout is NULL, then use 'cols' to determine layout
            if (is.null(layout)) {
                # Make the panel
                # ncol: Number of columns of plots
                # nrow: Number of rows needed, calculated from # of cols
                layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                                 ncol = cols, nrow = ceiling(numPlots/cols))
            }
            
            if (numPlots==1) {
                print(plots[[1]])
                
            } else {
                # Set up the page
                grid.newpage()
                pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
                
                # Make each plot, in the correct location
                for (i in 1:numPlots) {
                    # Get the i,j matrix positions of the regions that contain this subplot
                    matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
                    
                    print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                                    layout.pos.col = matchidx$col))
                }
            }
        }
```

This section explores whether to model HIV testing as an interval process or a memoryless process. If as an interval process, we assume that men test at regular intervals. Since the survey was not associated wtih any testing event, we assume the survey date is randomly distributed wtihin men's intervals, such that on average it will fall halfway between their testing events. As such, the intertest interval is calculated as twice the reported days since the last test. If we model testing as a memoryless process, men are assumed to have a constant hazard of testing, such that the data follow an exponential distribution. Under this assumption, the expected time between tests is the average time from the last test.

In looking at the testing intervals, we exclude men who report current use of PrEP, as these men will have different testing patterns that will be represented using separate parameters in the model. If we assume testing is an interval process, the median intertest interval is `r median(2*sample_allages$daysago_lasttest[!(sample$prep_use_r %in% "Currently taking PrEP")], na.rm=TRUE)` and the mean is `r mean(sample_allages$daysago_lasttest[!(sample$prep_use_r %in% "Currently taking PrEP")], na.rm=TRUE)`. If we assume testing is a memoryless process, the median intertest interval is `r median(sample_allages$daysago_lasttest[!(sample$prep_use_r %in% "Currently taking PrEP")], na.rm=TRUE)` and the mean is `r mean(sample_allages$daysago_lasttest[!(sample$prep_use_r %in% "Currently taking PrEP")], na.rm=TRUE)`.

Plot \@ref(fig:iti_interval) shows the median and mean intertest intervals calculated as an interval process by respondent age. 
```{r plots_iti_interval}

#Intertest interval by age 
    iti_intervalXage <- sample %>% filter(!is.na(daysago_lasttest) & prep_use_r !="Currently taking PrEP") %>% group_by(age) %>% summarise(freq=n(), median=median(2*daysago_lasttest, na.rm=TRUE), mean=mean(2*daysago_lasttest, na.rm=TRUE))
    
    ggplot(iti_intervalXage) + geom_point(aes(x=age, y=median, size=freq, colour="Median")) + geom_point(aes(x=age, y=mean, size=freq, colour="Mean")) + geom_smooth(aes(x=age, y=median), method="loess") + geom_smooth(aes(x=age, y=mean), method="loess") + scale_colour_manual(name="Measure", values=c("Median" = "blue", "Mean"="red")) + labs(x="Ego age", y="Days since last test", title="Mean and median intertest intervals by age, assuming testing is an interval process")
```

<span style="color:red"> Fill in: Median looks better. In the model, we get to pick one summary statistic to model. For interval data that can be skewed easily by outliers, median may be more stable. Also median gets us results that more closely match what we've seen in other studies (cite what use in Mardham) and what STD clinic data show (cite) </span>.