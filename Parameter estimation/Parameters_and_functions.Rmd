# Model parameters and functions {#parameters}
```{r, echo=FALSE, include=FALSE}

####################################################################################
# Setup
####################################################################################
#-----------------------------------------------------------------------------------
# Load packages
#-----------------------------------------------------------------------------------

    library("tidyverse")
    library("psych") #To use "describe" function for continuous vars
    library("ggplot2")
    library("survey")
    library("knitr")
    library("kableExtra")

#-----------------------------------------------------------------------------------
# Load data
#-----------------------------------------------------------------------------------
    load(file="Data/InternetSurveySample.Rdata")
    load(file="Data/InternetSurvey_reweighted_all.Rdata")
    load(file="Data/InternetSurvey_reweighted_neg.Rdata")

# Set options
    opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
    options(knitr.table.format = "html") 
    
```

This section summarises the parameters defined for the model, with reference to their sources and limitations. It also lists key model functions that were modified for this project and describes the changes made.

```{r parameters, warning=FALSE}
# write a function to define the table structure and add a row to the table with a new parameter or attribute
param_table <- function(table, param, description, value, alt_value, sources){
    row <- cbind.data.frame("Parameter" = param, "Description" = description, "Value" = value, "Alternate value(s)" = alt_value, "Source(s)" = sources)

    if(is.na(table)){
        table <- row
    } else {
        table <- rbind.data.frame(table, row)
    }
   
    return(table)
}

# Add rows for each parameter
 #Time step
  parameters <- param_table(NA, "time.unit", "Unit of time relative to one day", 7, NA, NA)
  
 #Network composition
  parameters <- param_table(parameters, "prop.H.KC", "Proportion of the population that lives in King County and is Hispanic", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[1,1], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.B.KC", "Proportion of the population that lives in King County and is black", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[1,2], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.O.KC", "Proportion of the population that lives in King County and is other race/ethnicity", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[1,3], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.H.OW", "Proportion of the population that lives in other Western WA counties and is Hispanic", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[2,1], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.B.OW", "Proportion of the population that lives in other Western WA counties and is black", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[2,2], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.O.OW", "Proportion of the population that lives in other Western WA counties and is other race/ethnicity", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[2,3], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.H.EW", "Proportion of the population that lives in Eastern WA counties and is Hispanic", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[3,1], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.B.EW", "Proportion of the population that lives in Eastern WA counties and is black", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[3,2], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.O.EW", "Proportion of the population that lives in Eastern Western WA counties and is other race/ethnicity", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[3,3], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.18to24", "Proportion of the population aged 18 to 24", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[1], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.25to29", "Proportion of the population aged 25 to 29", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[2], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.30to34", "Proportion of the population aged 30 to 34", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[3], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.35to39", "Proportion of the population aged 35 to 39", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[4], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.40to49", "Proportion of the population aged 40 to 49", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[5], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.50to59", "Proportion of the population aged 50 to 59", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[6], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  
  #Degree distribution by race/ethnicity, region, and age
  parameters <- param_table(parameters, "deg.mp", "Overall degree distribution (order: 0 main 0 pers, 0 main 1 pers, 0 main 2+ pers, 1 main 0 pers, 1 main 1 pers, 1 main 2+ pers)", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all, round=FALSE)),4))), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  parameters <- param_table(parameters, "deg.mp.age40to49", "Degree distribution for MSM aged 40-49", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all[sample_rake_all$variables$age_cat_alt %in% "40-49"], round=FALSE)),4))), collapse = ", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
   parameters <- param_table(parameters, "deg.mp.otherages", "Degree distribution for MSM aged 18-39 and 50-59", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all[!(sample_rake_all$variables$age_cat_alt %in% "40-49")], round=FALSE)),4))), collapse = ", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
   
   ==> By race and region, I think I either want parameters for the proportion of main partnerships that are reported by men of each race/ethnicty and region, OR I want the proportion of main partnerships in which either the ego or alter is of each racial/ethnic group / region. Would need to figure out how to do this for region. And maybe double-count edges if both the ego and alter are of that type?
  # parameters <- param_table(parameters, "deg.mp.H", "Degree distribution for Hispanic MSM", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all[sample_rake_all$variables$hbo %in% "Hispanic"], round=FALSE)),4))), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  # parameters <- param_table(parameters, "deg.mp.B", "Degree distribution for black MSM", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all[sample_rake_all$variables$hbo %in% "Black"], round=FALSE)),4))), collapse = ", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  # parameters <- param_table(parameters, "deg.mp.O", "Degree distribution for other race/ethnicity MSM", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all[sample_rake_all$variables$hbo %in% "Other"], round=FALSE)),4))), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  # parameters <- param_table(parameters, "deg.mp.KC", "Degree distribution for King County MSM", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all[sample_rake_all$variables$region %in% "King County"], round=FALSE)),4))), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  # parameters <- param_table(parameters, "deg.mp.OW", "Degree distribution for other western WA MSM", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all[sample_rake_all$variables$region %in% "Western WA"], round=FALSE)),4))), collapse = ", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  # parameters <- param_table(parameters, "deg.mp.EW", "Degree distribution for eastern WA MSM", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all[sample_rake_all$variables$region %in% "Eastern WA"], round=FALSE)),4))), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")


  
# Make a kable
rownames(parameters) <- NULL
kable(parameters, caption="Parameter values and sources", digits=c(0, 0, 4, 4, 0)) %>% kable_styling(full_width=F, position="center") %>% column_spec(1, width = "5cm") %>% column_spec(2, width = "10cm") %>% column_spec(3, width = "5cm") %>% column_spec(4, width = "8cm") %>% column_spec(5, width = "20cm") %>% group_rows("Model specifications", 1,1) %>% group_rows("Network composition",2,16) %>% group_rows("Degree distribution by nodal attribute", 17,24)
```

```{r functions}

```