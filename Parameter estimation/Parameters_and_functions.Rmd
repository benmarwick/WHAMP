# Model parameters and functions {#parameters}
```{r, echo=FALSE, include=FALSE}

####################################################################################
# Setup
####################################################################################
#-----------------------------------------------------------------------------------
# Load packages
#-----------------------------------------------------------------------------------

    library("tidyverse")
    library("psych") #To use "describe" function for continuous vars
    library("ggplot2")
    library("survey")
    library("knitr")
    library("kableExtra")

#-----------------------------------------------------------------------------------
# Load data
#-----------------------------------------------------------------------------------
    load(file="Data/InternetSurveySample.Rdata")
    load(file="Data/InternetSurvey_reweighted_all.Rdata")
    load(file="Data/InternetSurvey_reweighted_neg.Rdata")
    load(file="Data/rate_inst_mdeg.Rdata")
    load(file="Data/rate_inst_qrtmeans_18to49.Rdata")
    load(file="Data/rate_inst_qrtmeans_50to59.Rdata")
    load(file="Data/nodefactor_main_race.Rdata")
    load(file="Data/nodefactor_main_region.Rdata")
    load(file="Data/nodefactor_pers_age.Rdata")
    load(file="Data/rate_inst_mdeg.Rdata")
    load(file="Data/asmr.Rdata")

# Set options
    opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
    options(knitr.table.format = "html") 
    
```

This section summarises the parameters defined for the model, with reference to their sources and limitations. It also lists key model functions that were modified for this project and describes the changes made.

```{r parameters, warning=FALSE}
# write a function to define the table structure and add a row to the table with a new parameter or attribute
param_table <- function(table, param, description, value, alt_value, sources){
    row <- cbind.data.frame("Parameter" = param, "Description" = description, "Value" = value, "Alternate value(s)" = alt_value, "Source(s)" = sources)

    if(is.na(table)){
        table <- row
    } else {
        table <- rbind.data.frame(table, row)
    }
   
    return(table)
}

# Add rows for each parameter
 #Time step
  parameters <- param_table(NA, "time.unit", "Unit of time relative to one day", 7, NA, NA)
  
 #Network composition
  parameters <- param_table(parameters, "prop.H.KC", "Proportion of the population that lives in King County and is Hispanic", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[1,1], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.B.KC", "Proportion of the population that lives in King County and is black", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[1,2], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.O.KC", "Proportion of the population that lives in King County and is other race/ethnicity", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[1,3], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.H.OW", "Proportion of the population that lives in other Western WA counties and is Hispanic", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[2,1], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.B.OW", "Proportion of the population that lives in other Western WA counties and is black", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[2,2], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.O.OW", "Proportion of the population that lives in other Western WA counties and is other race/ethnicity", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[2,3], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.H.EW", "Proportion of the population that lives in Eastern WA and is Hispanic", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[3,1], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.B.EW", "Proportion of the population that lives in Eastern WA and is black", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[3,2], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.O.EW", "Proportion of the population that lives in Eastern WA and is other race/ethnicity", round(prop.table(svytable(~region + hbo, sample_rake_all, round=FALSE)),4)[3,3], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.18to24", "Proportion of the population aged 18 to 24", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[1], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.25to29", "Proportion of the population aged 25 to 29", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[2], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.30to34", "Proportion of the population aged 30 to 34", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[3], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.35to39", "Proportion of the population aged 35 to 39", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[4], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.40to49", "Proportion of the population aged 40 to 49", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[5], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  parameters <- param_table(parameters, "prop.50to59", "Proportion of the population aged 50 to 59", round(prop.table(svytable(~age_cat_alt, sample_rake_all, round=FALSE)),4)[6], NA, "2011-2015 American Community Survey (ACS) 5-year estimates [@WA-census] and estimates of the size of the MSM population by county [@Grey2016]")
  
  #Degree distribution by race/ethnicity, region, and age
  parameters <- param_table(parameters, "deg.mp", "Overall degree distribution (order: 0 main 0 pers, 0 main 1 pers, 0 main 2+ pers, 1 main 0 pers, 1 main 1 pers, 1 main 2+ pers)", paste(as.vector(t(round(prop.table(svytable(~degree_main + degreecat_cas, sample_rake_all, round=FALSE)),4))), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  parameters <- param_table(parameters, "prop.main.hbo", "Proportion of nodes in main partnerships that are Hispanic, Black, and Other", paste(as.vector(round(prop.inmainXrace, 4)), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM. EVENTUALLY REPLACE USING DATA ON MIXING BY RACE FROM MMP AND FROM THE WHPP SAMPLE REWEIGHTED TO NEG/UNK TOTALS. WILL NEED TO USE DATA FROM WHPP REWEIGHTED TO ALL FOR DEGREE")
  parameters <- param_table(parameters, "prop.main.region", "Proportion of nodes in main partnerships that are in King County, other counties in western WA, and eastern WA", paste(as.vector(round(prop.inmainXregion, 4)), collapse=", "), "Consider exploring scenarios with cross-regional mixing", "WHPP survey with assumptions about alters' region")
  parameters <- param_table(parameters, "prop.pers.40to49", "Proportion of nodes in persistent partnerships that are ages 18-39 or 50-59 vs. ages 40-49", "NULL - not included in the base model", paste(as.vector(round(prop.inpersXage, 4)), collapse=", "), "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM. EVENTUALLY REPLACE USING DATA ON MIXING BY AGE FROM MMP AND FROM THE WHPP SAMPLE REWEIGHTED TO NEG/UNK TOTALS. WILL NEED TO USE DATA FROM WHPP REWEIGHTED TO ALL FOR DEGREE")
    
  #Rate of instantaneous partnerships by degree and age
  parameters <- param_table(parameters, "rate.inst.mdeg", "Rate of instantaneous partnerships by momentary degree (order: 0 main 0 pers, 0 main 1 pers, 0 main 2+ pers, 1 main 0 pers, 1 main 1 pers, 1 main 2+ pers)", paste(c(meansXdegmatrix[1,1], meansXdegmatrix[1,2], meansXdegmatrix[1,3], meansXdegmatrix[2,1], meansXdegmatrix[2,2], meansXdegmatrix[2,3]), collapse = ", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  parameters <- param_table(parameters, "rates.inst.18to49", "Mean rate of instantaneous partnerships by quartile among men aged 18 to 49", paste(round(avg.qrtmeans.18to49, 6), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  parameters <- param_table(parameters, "rates.inst.50to59", "Mean rate of instantaneous partnerships by quartile among men aged 50 to 59",  paste(round(avg.qrtmeans.50to59, 6), collapse=", "), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  
  #Partnership duration
  parameters <- param_table(parameters, "durs.main", "Mean duration of main partnerships in days", as.numeric(round(svyquantile(~pship_age_main, sample_rake_all, quantile=.5, na.rm=TRUE)/log(2), 0)), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  parameters <- param_table(parameters, "durs.pers", "Mean duration of persistent partnerships in days", as.numeric(round(svyquantile(~pship_age_pers, sample_rake_all, quantile=.5, na.rm=TRUE)/log(2), 0)), NA, "WHPP survey, assumed to apply to HIV-negative and HIV-positive MSM")
  
  #Age- and race-specific mortality 
  parameters <- param_table(parameters, "asmr.ann.H", "Annual age-specific mortality rate for Hispanic men (for 5-year age groups from 15 to 59)", paste(round(asmr[,1]/100000, 5), collapse=", "), NA, "National Vital Statistics data, 2015")
  parameters <- param_table(parameters, "asmr.ann.B", "Annual age-specific mortality rate for black men (for 5-year age groups from 15 to 59)", paste(round(asmr[,2]/100000, 5), collapse=", "), NA, "National Vital Statistics data, 2015")
  parameters <- param_table(parameters, "asmr.ann.O", "Annual age-specific mortality rate for other men (for 5-year age groups from 15 to 59)", paste(round(asmr[,3]/100000, 5), collapse=", "), NA, "National Vital Statistics data, 2015")
  
# Make a kable
rownames(parameters) <- NULL
kable(parameters, caption="Parameter values and sources", digits=c(0, 0, 4, 4, 0)) %>% kable_styling(full_width=F, position="center") %>% column_spec(1, width = "5cm") %>% column_spec(2, width = "10cm") %>% column_spec(3, width = "5cm") %>% column_spec(4, width = "8cm") %>% column_spec(5, width = "20cm") %>% group_rows("Model specifications", 1,1) %>% group_rows("Network composition",2,16) %>% group_rows("Degree distribution by nodal attribute", 17,20) %>% group_rows("Rate of instantaneous partnerships", 21,23) %>% group_rows("Partnership duration", 24,25) %>% group_rows("Age-specific mortality", 26,28)
```

```{r functions}

```