# Mixing by age, race, and region

```{r, include=FALSE}
####################################################################################
# Setup
####################################################################################
#-----------------------------------------------------------------------------------
# Load packages
#-----------------------------------------------------------------------------------

    library("tidyverse")
    library("knitr")
    library("kableExtra")
    library("data.table")
    library("survey")

#-----------------------------------------------------------------------------------
# Knitr options
#-----------------------------------------------------------------------------------
opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
options(knitr.table.format = "html") 

#-----------------------------------------------------------------------------------
# Load data
#-----------------------------------------------------------------------------------
    load(file="Data/InternetSurveySample.Rdata")
    load(file="Data/InternetSurveySample_allages.Rdata")
    load(file="Data/InternetSurveySample_reweighted.Rdata")
   # load(file="Parameter estimation/Data/census_agebyregion.Rdata")
    # load(file="Parameter estimation/Data/census_racebyregion.Rdata")
    # load(file="Parameter estimation/Data/census_totalbyregion.Rdata")

    
#-----------------------------------------------------------------------------------
# Plot settings
#-----------------------------------------------------------------------------------
plot_background <- theme(panel.background = element_rect(fill="white", colour = "black")) +
            theme(panel.grid.major = element_line(colour = "grey90"))
theme_title <- theme(plot.title = element_text(hjust = 0.5, size=12)) 

#Define multiplot function
    multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
        library(grid)
        
        # Make a list from the ... arguments and plotlist
        plots <- c(list(...), plotlist)
        
        numPlots = length(plots)
        
        # If layout is NULL, then use 'cols' to determine layout
        if (is.null(layout)) {
            # Make the panel
            # ncol: Number of columns of plots
            # nrow: Number of rows needed, calculated from # of cols
            layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                             ncol = cols, nrow = ceiling(numPlots/cols))
        }
        
        if (numPlots==1) {
            print(plots[[1]])
            
        } else {
            # Set up the page
            grid.newpage()
            pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
            
            # Make each plot, in the correct location
            for (i in 1:numPlots) {
                # Get the i,j matrix positions of the regions that contain this subplot
                matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
                
                print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                                layout.pos.col = matchidx$col))
            }
        }
    }
    
        
```
This file examines balance in sexual mixing by race and age in data from participants in the internet survey. For this analysis, the data are re-weighted to match population totals (see section \@ref(reweight)). 

## Observed race mixing
In the internet survey, we observed the following partnership counts for main, persistent, and one-off partnerships by dyad race. 
```{r racemixing}
 racemix_main <- svytable(~hbo + mrp_hbo, sample_rake[sample_rake$variables$mrp_type_ongoing %in% "Main"], round=TRUE)
 racemix_pers <- svytable(~hbo + mrp_hbo, sample_rake[sample_rake$variables$mrp_type_ongoing %in% "Persistent"], round=TRUE)
 racemix_inst <- svytable(~hbo + mrp_hbo, sample_rake[sample_rake$variables$mrp_type_r %in% "One time"], round=TRUE)

    kable(racemix_main, caption="Race mixing in main partnerships") %>% kable_styling(full_width=F, position="center") %>% add_header_above(c("Ego race/ethnicity", "Partner race/ethnicity" = 3))
    kable(racemix_pers, caption="Race mixing in persistent partnerships") %>% kable_styling(full_width=F, position="center") %>% add_header_above(c("Ego race/ethnicity", "Partner race/ethnicity" = 3))
    kable(racemix_inst, caption="Race mixing in instantaneous partnerships") %>% kable_styling(full_width=F, position="center") %>% add_header_above(c("Ego race/ethnicity", "Partner race/ethnicity" = 3))

```
Table \@ref(tab:racemixing) shows that there are some imbalances in the observed mixing patterns.

## Observed age mixing
In the internet survey, we observed the following partnership counts for main, persistent, and one-off partnerships by ego and alter age group.

```{r agemixing}
    sample_rake$variables$age_cat_crude <- cut(sample_rake$variables$age, c(17, 24, 34, 44, 59), labels=c("18-24", "25-34", "35-44", "45-59"))
    sample_rake$variables$mrp_age_cat_crude <- cut(sample_rake$variables$mrp_ageinyears_approx, c(17, 24, 34, 44, 59), labels=c("18-24", "25-34", "35-44", "45-59"))    

    agemix_main <- svytable(~age_cat_crude + mrp_age_cat_crude, sample_rake[sample_rake$variables$mrp_type_ongoing %in% "Main"], round=TRUE)
    agemix_pers <- svytable(~age_cat_crude + mrp_age_cat_crude, sample_rake[sample_rake$variables$mrp_type_ongoing %in% "Persistent"], round=TRUE)
    agemix_inst <- svytable(~age_cat_crude + mrp_age_cat_crude, sample_rake[sample_rake$variables$mrp_type_r %in% "One time"], round=TRUE)

    kable(agemix_main, caption="Age mixing in main partnerships") %>% kable_styling(full_width=F, position="center") %>% add_header_above(c("Ego age", "Partner age" = 4))
    kable(agemix_pers, caption="Age mixing in persistent partnerships") %>% kable_styling(full_width=F, position="center") %>% add_header_above(c("Ego age", "Partner age" = 4))
    kable(agemix_inst, caption="Age mixing in instantaneous partnerships") %>% kable_styling(full_width=F, position="center") %>% add_header_above(c("Ego age", "Partner age" = 4))

```