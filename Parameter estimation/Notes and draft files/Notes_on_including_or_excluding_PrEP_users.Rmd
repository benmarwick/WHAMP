# Exploring whether certain behavioral parameters differ for PrEP users
This section explores whether condom use, the rate of instantaneous partnerships, and sex role differ by PrEP use, comparing men who are using PrEP or whose partners are using PrEP with men who have not used PREP in the past 12 months and who do not know that their partners are using PrEP. This analysis is to explore whether we need to specify values for these parameters for PrEP users and non-users. If so, we will use data from men not on PrEP who are similar to PrEP users (e.g. matchd on demographics and risk behaviors) to impute what the behaviors of PrEP users woudl be in the absence of PrEP. If we were to just exclude these men, we would be excluding higher risk men from the network, since PrEP use is targeted to those with higher risk behaiors.

```{r, include=FALSE}
####################################################################################
# Setup
####################################################################################
#-----------------------------------------------------------------------------------
# Load packages
#-----------------------------------------------------------------------------------

    library("tidyverse")
    library("knitr")
    library("data.table")
    library("lmtest")
    library("kableExtra")
    library("logbin")

#-----------------------------------------------------------------------------------
# Knitr options
#-----------------------------------------------------------------------------------
opts_chunk$set(echo=FALSE, message=FALSE, warning=TRUE, error=TRUE, fig.align = "center")
options(knitr.table.format = "html") 

#-----------------------------------------------------------------------------------
# Plot settings
#-----------------------------------------------------------------------------------
#save plot settings for white background and light grey lines and darkening the colors a bit
plot_background <- theme(panel.background = element_rect(fill="white", colour = "black")) + theme(panel.grid.major = element_line(colour = "grey90"))
darken_color <- scale_colour_hue(l=50)
theme_title <- theme(plot.title = element_text(hjust = 0.5, size=12)) 
        
#-----------------------------------------------------------------------------------
# Load data
#-----------------------------------------------------------------------------------
setwd("/homes/dpwhite/R/GitHub Repos/WHAMP/Parameter estimation")
load(file="Data/InternetSurveySample.Rdata")
load(file="Data/InternetSurveySample_allages.Rdata")

#-----------------------------------------------------------------------------------
# Define alternate age categorization
#-----------------------------------------------------------------------------------
    sample$age_cat_alt <- cut(sample$age, c(17, 24, 29, 34, 39, 49, 59), labels=c("18-24", "25-29", "30-34", "35-39", "40-49", "50-59"))

#-----------------------------------------------------------------------------------
# Define a variable that differentiates men using PrEP from those who have not used PREP in the past 12 months
#-----------------------------------------------------------------------------------
    #Taking into account ego's PrEP use for looking at rate inst and sex role
    sample$egoprep_p12 <- ifelse((sample$prep_use_r %in% "Currently taking PrEP" | sample$monthsago_lastprep %in% c(0:12)), "PrEP use",
                    ifelse((sample$prep_use_r %in% c("Took PrEP in the past", "Never taken PrEP")) & !(sample$monthsago_lastprep %in% c(0:12)), 
                    "No recent PrEP use", NA))
    #Also taking into account alter's PREP user for looking at condom use
    sample$dyadprep_p12 <- ifelse((sample$prep_use_r %in% "Currently taking PrEP" | sample$monthsago_lastprep %in% c(0:12)) | (sample$mrp_prep_r %in% 1), "PrEP use", ifelse((sample$prep_use_r %in% c("Took PrEP in the past", "Never taken PrEP")) & !(sample$monthsago_lastprep %in% c(0:12)) & !(sample$mrp_prep_r %in% 99), "No recent PrEP use", NA))

#-----------------------------------------------------------------------------------
# Define the subset of the sample that excludes men who are using or used PrEP in the past 12 months or whose partners were using PrEP at last sex
#-----------------------------------------------------------------------------------
    sample_p12noprep <- sample %>% filter((prep_use_r %in% c("Took PrEP in the past", "Never taken PrEP")) & !(monthsago_lastprep %in% c(0:12)))
    sample_p12noprep_noalterprep <- sample %>% filter((prep_use_r %in% c("Took PrEP in the past", "Never taken PrEP")) & !(monthsago_lastprep %in% c(0:12)) & !(mrp_prep_r %in% 1))
    
#----------------------------------------------------------------------------------
# Define multiplot function
#_---------------------------------------------------------------------------------
        multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
            library(grid)
            
            # Make a list from the ... arguments and plotlist
            plots <- c(list(...), plotlist)
            
            numPlots = length(plots)
            
            # If layout is NULL, then use 'cols' to determine layout
            if (is.null(layout)) {
                # Make the panel
                # ncol: Number of columns of plots
                # nrow: Number of rows needed, calculated from # of cols
                layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                                 ncol = cols, nrow = ceiling(numPlots/cols))
            }
            
            if (numPlots==1) {
                print(plots[[1]])
                
            } else {
                # Set up the page
                grid.newpage()
                pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
                
                # Make each plot, in the correct location
                for (i in 1:numPlots) {
                    # Get the i,j matrix positions of the regions that contain this subplot
                    matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
                    
                    print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                                    layout.pos.col = matchidx$col))
                }
            }
        }

#-----------------------------------------------------------------------------------
# Write function to streamline analyses
#-----------------------------------------------------------------------------------
#Function to plot the coefficients for age
plot.age.coefs <- function(full) {
    agecoefs <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(full$coefficients[2:8]), se = as.vector(coef(summary(full))[2:8,2]))
    plot <- ggplot(agecoefs, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% confidence intervals for age")
    return(plot) + theme_title + plot_background
}

#Function to get likelihood ratio tests
    #Outcomes for which we are looking at age, race, and region
    compare.models <- function(full, noreg, norace, noage, full_withint, noraceXreg, noageXreg, noraceXage) {
        lrt_region <- lrtest(full, noreg)
        lrt_race <- lrtest(full, norace)
        lrt_age <- lrtest(full, noage)
        lrt_summary_main <- cbind.data.frame("Variable" = c("Region", "Race", "Age"), "pvalue" = c(round(lrt_region$'Pr(>Chisq)'[2], 4), round(lrt_race$'Pr(>Chisq)'[2], 4), round(lrt_age$'Pr(>Chisq)'[2], 4)))
        lrt_summary_main$sig <- ifelse(lrt_summary_main$pvalue<0.001, "***", ifelse(lrt_summary_main$pvalue<0.01, "**", ifelse(lrt_summary_main$pvalue<0.05, "*", "")))
        
        lrt_raceXreg <- lrtest(full_withint, noraceXreg)
        lrt_ageXreg <- lrtest(full_withint, noageXreg)
        lrt_raceXage <- lrtest(full_withint, noraceXage)
        lrt_summary_int <- cbind.data.frame("Variable" = c("Race by region", "Age by region", "Race by age"), "pvalue" = c(round(lrt_raceXreg$'Pr(>Chisq)'[2], 4), round(lrt_ageXreg$'Pr(>Chisq)'[2], 4), round(lrt_raceXage$'Pr(>Chisq)'[2], 4)))
        lrt_summary_int$sig <-  ifelse(lrt_summary_int$pvalue<0.001, "***", ifelse(lrt_summary_int$pvalue<0.01, "**", ifelse(lrt_summary_int$pvalue<0.05, "*", "")))
    
        #results <- list(summary(full), lrt_summary_main, summary(full_withint), lrt_summary_int)
        results <- list(lrt_summary_main, lrt_summary_int)

        return(results)
    }

#Outcomes for which we are looking only at race and region
    compare.models.noage <- function(full, noreg, norace, full_withint, noraceXreg) {
        lrt_region <- lrtest(full, noreg)
        lrt_race <- lrtest(full, norace)
        lrt_summary_main <- cbind.data.frame("Variable" = c("Region", "Race", "Age"), "pvalue" = as.numeric(c(round(lrt_region$'Pr(>Chisq)'[2], 4), round(lrt_race$'Pr(>Chisq)'[2], 4), "")))
        lrt_summary_main$sig <- ifelse(lrt_summary_main$pvalue<0.001, "***", ifelse(lrt_summary_main$pvalue<0.01, "**", ifelse(lrt_summary_main$pvalue<0.05, "*", "")))
        
        lrt_raceXreg <- lrtest(full_withint, noraceXreg)
        lrt_summary_int <- cbind.data.frame("Variable" = c("Race by region", "Age by region", "Race by age"), "pvalue" = as.numeric(c(round(lrt_raceXreg$'Pr(>Chisq)'[2], 4), "", "")))
        lrt_summary_int$sig <-  ifelse(lrt_summary_int$pvalue<0.001, "***", ifelse(lrt_summary_int$pvalue<0.01, "**", ifelse(lrt_summary_int$pvalue<0.05, "*", "")))
    
        #results <- list(summary(full), lrt_summary_main, summary(full_withint), lrt_summary_int)
        results <- list(lrt_summary_main, lrt_summary_int)
        
        return(results)
    }

```

## Rate of instantaneous partnerships
First we look at whether the rate of instantaneous partnerships overall differs by PrEP use.
```{r}
#Distribution of instantaneous partnerships by PrEP use
    rateinst_distXprep <- sample %>% filter(!is.na(egoprep_p12) & !is.na(rate_inst)) %>% mutate(noinst = ifelse(rate_inst %in% 0, 1, ifelse(!is.na(rate_inst), 0, NA))) %>% group_by(egoprep_p12) %>% summarise(freq=n(), prop.noinst=mean(noinst, na.rm=TRUE), median = median(rate_inst, na.rm = TRUE), mean = mean(rate_inst, na.rm=TRUE))
    kable(rateinst_distXprep, col.names=c("PrEP use", "N", "% with 0 partners", "Median rate", "Mean rate"), digits=c(0, 0, 3, 3, 3), caption="Rate of instantaneous partnerships by PrEP use") %>% kable_styling(full_width=F, position="center")
```

The plots below show the proportion of men in each quartile of the distribution of the rate of instantaneous partnerships (quartiles defined for the entire sample) by PrEP use.
```{r}
#Plot of the proportion in each quartile (quartiles defined for the full sample) by PrEP use
    quartiles <- quantile(sample$rate_inst, c(0.025, 0.5, 0.75, 1), na.rm=TRUE)
    sample$rate_inst_quart <- cut(sample$rate_inst, c(-0.01, quartiles), labels=c("Zero", "Low", "Med", "High"))
    
     quartileXnoprep <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "No recent PrEP use") %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     quartileXprep <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "PrEP use") %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     
    ggplot() + geom_pointrange(data=quartileXnoprep, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="a")) +  geom_pointrange(data=quartileXprep, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Quartile", y="Percent", title="Quantile distribution of the rate of instantaneous partners by PrEP use") + theme_title + plot_background 
```

The plot below shows the proportion of men in each quartile by PrEP use and momentary degree.
```{r}
# Plot of the proportion in each quartile by momentary degree and PrEP use
     quartileXnoprep_nomain <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "No recent PrEP use" & degree_main %in% 0) %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     quartileXnoprep_main <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "No recent PrEP use" & degree_main %in% 1) %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     quartileXnoprep_nopers <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "No recent PrEP use" & anypers %in% 0) %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     quartileXnoprep_pers <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "No recent PrEP use" & anypers %in% 1) %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     
      quartileXprep_nomain <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "PrEP use" & degree_main %in% 0) %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     quartileXprep_main <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "PrEP use" & degree_main %in% 1) %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     quartileXprep_nopers <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "PrEP use" & anypers %in% 0) %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     quartileXprep_pers <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "PrEP use" & anypers %in% 1) %>% add_tally() %>% group_by(rate_inst_quart) %>% summarise(freq = n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), lower_ci = max((prop - 1.96*se), 0), upper_ci = min((prop + 1.96*se), 1))
     
    p_nomain <- ggplot() + geom_pointrange(data=quartileXnoprep_nomain, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="a")) +  geom_pointrange(data=quartileXprep_nomain, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Quartile", y="Percent", title="No main partner") + theme_title + plot_background + ylim(0, .8) + theme(legend.position="none")
     p_main <- ggplot() + geom_pointrange(data=quartileXnoprep_main, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="a")) +  geom_pointrange(data=quartileXprep_main, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Quartile", y="Percent", title="Main partner") + theme_title + plot_background + ylim(0, .8) + theme(legend.position="none")
      p_nopers <- ggplot() + geom_pointrange(data=quartileXnoprep_nopers, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="a")) +  geom_pointrange(data=quartileXprep_nopers, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Quartile", y="Percent", title="No persistent partners") + theme_title + plot_background + ylim(0, .8) + theme(legend.position="none")
       p_pers <- ggplot() + geom_pointrange(data=quartileXnoprep_pers, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="a")) +  geom_pointrange(data=quartileXprep_pers, aes(x=rate_inst_quart, y=prop, ymin=lower_ci, ymax=upper_ci, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Quartile", y="Percent", title="One or more persistent partners") + theme_title + plot_background + ylim(0, .8) + theme(legend.position="none")
    
    multiplot(p_nomain, p_nopers, p_main, p_pers, cols=2)
    
 ```
 
 And this plot shows the proportion of men in each quartile by PrEP use and age.
 ```{r}
# Plot the proportion in each quartile by age and PrEP use
    ageXquartile_noprep <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "No recent PrEP use") %>% group_by(age_cat) %>% summarise(freq=n(), zero = sum(rate_inst_quart %in% "Zero")/freq, se_zero = sqrt((zero*(1-zero))/freq), lower_zero = max((zero - 1.96*se_zero), 0), upper_zero = min((zero + 1.96*se_zero), 1), low = sum(rate_inst_quart %in% "Low")/freq, se_low = sqrt((low*(1-low))/freq), lower_low = max((low - 1.96*se_low), 0), upper_low = min((low + 1.96*se_low), 1), med = sum(rate_inst_quart %in% "Med")/freq, se_med = sqrt((med*(1-med))/freq), lower_med = max((med - 1.96*se_med), 0), upper_med = min((med + 1.96*se_med), 1), high = sum(rate_inst_quart %in% "High")/freq, se_high = sqrt((high*(1-high))/freq), lower_high = max((high - 1.96*se_high), 0), upper_high = min((high + 1.96*se_high), 1))
      ageXquartile_prep <- sample %>% filter(!is.na(rate_inst) & egoprep_p12 %in% "PrEP use") %>% group_by(age_cat) %>% summarise(freq=n(), zero = sum(rate_inst_quart %in% "Zero")/freq, se_zero = sqrt((zero*(1-zero))/freq), lower_zero = max((zero - 1.96*se_zero), 0), upper_zero = min((zero + 1.96*se_zero), 1), low = sum(rate_inst_quart %in% "Low")/freq, se_low = sqrt((low*(1-low))/freq), lower_low = max((low - 1.96*se_low), 0), upper_low = min((low + 1.96*se_low), 1), med = sum(rate_inst_quart %in% "Med")/freq, se_med = sqrt((med*(1-med))/freq), lower_med = max((med - 1.96*se_med), 0), upper_med = min((med + 1.96*se_med), 1), high = sum(rate_inst_quart %in% "High")/freq, se_high = sqrt((high*(1-high))/freq), lower_high = max((high - 1.96*se_high), 0), upper_high = min((high + 1.96*se_high), 1))
    
      p_zero <- ggplot() + geom_pointrange(data=ageXquartile_noprep, aes(x=age_cat, y=zero, ymin=lower_zero, ymax=upper_zero, colour="a")) + geom_pointrange(data=ageXquartile_prep, aes(x=age_cat, y=zero, ymin=lower_zero, ymax=upper_zero, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Age group", y="Percent", title="Zero instantaneous partners") + theme_title + plot_background + theme(legend.position="none")
      p_low <- ggplot() + geom_pointrange(data=ageXquartile_noprep, aes(x=age_cat, y=low, ymin=lower_low, ymax=upper_low, colour="a")) + geom_pointrange(data=ageXquartile_prep, aes(x=age_cat, y=low, ymin=lower_low, ymax=upper_low, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Age group", y="Percent", title="Low rate of instantaneous partners") + theme_title + plot_background + theme(legend.position="none")
      p_med <- ggplot() + geom_pointrange(data=ageXquartile_noprep, aes(x=age_cat, y=med, ymin=lower_med, ymax=upper_med, colour="a")) + geom_pointrange(data=ageXquartile_prep, aes(x=age_cat, y=med, ymin=lower_med, ymax=upper_med, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Age group", y="Percent", title="Medium rate of instantaneous partners") + theme_title + plot_background + theme(legend.position="none")
     p_high <- ggplot() + geom_pointrange(data=ageXquartile_noprep, aes(x=age_cat, y=high, ymin=lower_high, ymax=upper_high, colour="a")) + geom_pointrange(data=ageXquartile_prep, aes(x=age_cat, y=high, ymin=lower_high, ymax=upper_high, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Age group", y="Percent", title="High rate of instantaneous partners") + theme_title + plot_background + theme(legend.position="none")
    
     multiplot(p_zero, p_med, p_low, p_high, cols=2)

```

The data indicate that there are clear differences between PrEP users and non-PrEP users in terms of the rate of instantaneous partnerships, with a general pattern of greater proportion of PrEP users being in the highest quartile of the distribution and a lower proportion having zero instantaneous partners. This could be simply a reflection of the fact that PrEP use is targeted to higher risk men, but it could also be due to risk compensation. Either way, it is clear that using data only from non-PrEP users would yield a very different estimate of the rate of instantaneous partnerships than using data from the full sample.

## Condom use
The table below presents the mean probability of condom use by partner type and PrEP use (by the ego in the past 12 months or by his partner at last sex), and the proportion of men who report always and never using condoms. For instantaneous partnerships, these latter two measures convey the same information as the mean since men only reported on sex with one one-time partner. The plot shows the mean probobability with error bars indicating the 95% condfidence intervals.
```{r}
    condoms_mainXprep <- sample %>% filter(!is.na(dyadprep_p12) & !is.na(condoms_main)) %>% group_by(dyadprep_p12) %>% summarise(freq = n(), mean = mean(condoms_main), prop.never = sum((condoms_main %in% 0)/freq), prop.always = sum(condoms_main %in% 1)/freq, se=sd(condoms_main)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1), ptype = "Main")
    condoms_persXprep <- sample %>% filter(!is.na(dyadprep_p12) & !is.na(condoms_pers)) %>% group_by(dyadprep_p12) %>% summarise(freq = n(), mean = mean(condoms_pers), prop.never = sum((condoms_pers %in% 0)/freq), prop.always = sum(condoms_pers %in% 1)/freq, se=sd(condoms_pers)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1), ptype = "Persistent")
    condoms_instXprep <- sample %>% filter(!is.na(dyadprep_p12) & !is.na(condoms_inst)) %>% group_by(dyadprep_p12) %>% summarise(freq = n(), mean = mean(condoms_inst), prop.never = sum((condoms_inst %in% 0)/freq), prop.always = sum(condoms_inst %in% 1)/freq, se=sd(condoms_inst)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1), ptype = "Instantaneous")
    
# Table
    condomsXprep_tbl <- rbind.data.frame(condoms_mainXprep[,1:5], condoms_persXprep[,1:5], condoms_instXprep[,1:5])
    
    kable(condomsXprep_tbl, col.names=c("PrEP use", "N", "Mean", "% never", "% always"), digits=c(0, 0, 3, 3, 3), caption="Condom use by past 12 month PrEP use") %>% group_rows("Main partnerships", 1, 2) %>% group_rows("Persistent partnerships", 3, 4) %>% group_rows("Instantaneous partnerships", 5, 6) %>% kable_styling(full_width=T, position="center")
    
# Plot
    condomsXprep_plot <- rbind.data.frame(condoms_mainXprep, condoms_persXprep, condoms_instXprep)
    condomsXprep_plot$ptype <- factor(condomsXprep_plot$ptype, levels = c("Main", "Persistent", "Instantaneous"))

    ggplot(condomsXprep_plot) + geom_pointrange(aes(x=ptype, y=mean, ymin=ci_lower, ymax=ci_upper, colour=dyadprep_p12),  position=position_dodge(0.1)) +  labs(x="Partnership type", y="Mean probability", title="Mean probability of condom use by PrEP use") + guides(colour = guide_legend(title=NULL)) + plot_background + theme_title
    
    
    
```

The plots below show the mean probability of condom use in each partnership type by dyad age and PrEP use.

```{r}
#Define dyad age category variable
    sample$dyad_age <- ifelse(sample$age %in% c(18:34) & sample$mrp_ageinyears_approx %in% c(18:34), "YY", ifelse(sample$age %in% c(18:34) & sample$mrp_ageinyears_approx %in% c(35:59), "YO", ifelse(sample$age %in% c(35:59) & sample$mrp_ageinyears_approx %in% c(18:34), "OY", ifelse(sample$age %in% c(35:59) & sample$mrp_ageinyears_approx %in% c(35:59), "OO", NA))))
    #Specify order of dyad age
    sample$dyad_age <- factor(sample$dyad_age, levels = c("YY", "YO", "OY", "OO"))

#Condom use in main partnerships by dyad age
    condoms_mainXdyadage_noprep <- sample %>% filter(!is.na(condoms_main) & !is.na(dyad_age) & dyadprep_p12 %in% "No recent PrEP use") %>% group_by(dyad_age) %>% summarise(freq=n(), mean=mean(condoms_main), se=sd(condoms_main)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1))
    condoms_mainXdyadage_prep <- sample %>% filter(!is.na(condoms_main) & !is.na(dyad_age) & dyadprep_p12 %in% "PrEP use") %>% group_by(dyad_age) %>% summarise(freq=n(), mean=mean(condoms_main), se=sd(condoms_main)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1))
    
    ggplot() + geom_pointrange(data=condoms_mainXdyadage_noprep, aes(x=dyad_age, y=mean, ymin=ci_lower, ymax=ci_upper, colour="a")) + geom_pointrange(data=condoms_mainXdyadage_prep, aes(x=dyad_age, y=mean, ymin=ci_lower, ymax=ci_upper, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Dyad age", y="Mean probability of condom use", title = "Mean probability of condom use in main partnerships \n by dyad age and PrEP use") + theme_title + plot_background

#Condom use in persistent partnerships by dyad age
    condoms_persXdyadage_noprep <- sample %>% filter(!is.na(condoms_pers) & !is.na(dyad_age) & dyadprep_p12 %in% "No recent PrEP use") %>% group_by(dyad_age) %>% summarise(freq=n(), mean=mean(condoms_pers), se=sd(condoms_pers)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1))
    condoms_persXdyadage_prep <- sample %>% filter(!is.na(condoms_pers) & !is.na(dyad_age) & dyadprep_p12 %in% "PrEP use") %>% group_by(dyad_age) %>% summarise(freq=n(), mean=mean(condoms_pers), se=sd(condoms_pers)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1))
    
    ggplot() + geom_pointrange(data=condoms_persXdyadage_noprep, aes(x=dyad_age, y=mean, ymin=ci_lower, ymax=ci_upper, colour="a")) + geom_pointrange(data=condoms_persXdyadage_prep, aes(x=dyad_age, y=mean, ymin=ci_lower, ymax=ci_upper, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Dyad age", y="Mean probability of condom use", title = "Mean probability of condom use in persistent partnerships \n by dyad age and PrEP use") + theme_title + plot_background
    
    #Condom use in instantaneous partnerships by dyad age
    condoms_instXdyadage_noprep <- sample %>% filter(!is.na(condoms_inst) & !is.na(dyad_age) & dyadprep_p12 %in% "No recent PrEP use") %>% group_by(dyad_age) %>% summarise(freq=n(), mean=mean(condoms_inst), se=sd(condoms_inst)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1))
    condoms_instXdyadage_prep <- sample %>% filter(!is.na(condoms_inst) & !is.na(dyad_age) & dyadprep_p12 %in% "PrEP use") %>% group_by(dyad_age) %>% summarise(freq=n(), mean=mean(condoms_inst), se=sd(condoms_inst)/sqrt(freq), ci_lower = max((mean - 1.96*se), 0), ci_upper = min((mean + 1.96*se), 1))
    
    ggplot() + geom_pointrange(data=condoms_instXdyadage_noprep, aes(x=dyad_age, y=mean, ymin=ci_lower, ymax=ci_upper, colour="a")) + geom_pointrange(data=condoms_instXdyadage_prep, aes(x=dyad_age, y=mean, ymin=ci_lower, ymax=ci_upper, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Dyad age", y="Mean probability of condom use", title = "Mean probability of condom use in instantaneous partnerships \n by dyad age and PrEP use") + theme_title + plot_background
```

As with the rate of instantaneous partnerships, we see that condom use differs in dyads in which one or both parters used PrEP from dyads in which neither partner used PREP in the past 12 months. By age, these differences were primarily in main and persistent partnerships between two young men and in instantaneous partnerships between two older men. Again, this could be simply a reflection of the fact that PrEP use is targeted to higher risk men who may have been less likely to use condoms before starting PrEP, but it could also be due to risk compensation. Either way, using data only from non-PrEP users will produce different estimates of the rate of instantaneous partnerships than using data from the full sample, and it is unclear how much of this difference is due to risk compensation. These data suggest that imputing the likely counterfactual values for condom use in PrEP users is indicated.

## Sex role

```{r}
    sexroleXnoprep <- sample %>% filter(!is.na(position_cat) & egoprep_p12 %in% "No recent PrEP use") %>% add_tally() %>% group_by(position_cat) %>% summarise(freq=n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), ci_lower = max((prop- 1.96*se), 0), ci_upper = min((prop + 1.96*se), 1))
    sexroleXprep <- sample %>% filter(!is.na(position_cat) & egoprep_p12 %in% "PrEP use") %>% add_tally() %>% group_by(position_cat) %>% summarise(freq=n(), n=max(n), prop = freq/n, se = sqrt((prop*(1-prop))/n), ci_lower = max((prop- 1.96*se), 0), ci_upper = min((prop + 1.96*se), 1))
    
    ggplot() + geom_pointrange(data=sexroleXnoprep, aes(x=position_cat, y=prop, ymin=ci_lower, ymax=ci_upper, colour="a")) + geom_pointrange(data=sexroleXprep, aes(x=position_cat, y=prop, ymin=ci_lower, ymax=ci_upper, colour="b")) + scale_colour_manual(name = "PrEP use", values=c("a"="blue", "b"="orange"), labels=c("No recent PrEP", "PrEP use")) + labs(x="Anal sex role", y="Proportion", title = "Anal sex role by PrEP use") + theme_title + plot_background

```

The plot for sex role also suggests some differences in anal sex role by PrEP use. Interestingly, PrEP non-users are more likely to report being exclusive bottoms than PrEP users.


# Exploring the effects of including/excluding PrEP users in estimation of behavioral parameters
Above we saw that there are differnences in the reported behaviors of PrEP users and PrEP non-users. This section examines the implications for determining the model structure by looking at whether we would reach different conclusions on how to structure the model on age, race/ethnicity and region by including or excluding data from men who have used PrEP or whose partners are using PrEP.

## Rate of instantaneous partners
This analysis looks at heterogeneity in the rate of one-time partnerships separately for men who have 0 main, those who have 1 main, those who have 0 persistent, and those who have one or more persistent partnerships. __In this analysis, we compare the findings from models including and excluding data from men who used PrEP in the past 12 months or whose partners used PrEP.__

### No main partners
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins.
```{r}
#Figure out how to parameterize age

 #Full sample
    rateinst_nomain_testage_all <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 0)
    agecoefs_rateinst_nomain_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_nomain_testage_all$coefficients[2:8]), se = as.vector(coef(summary(rateinst_nomain_testage_all))[2:8,2]))
    ageplot_rateinst_nomain_all <- ggplot(agecoefs_rateinst_nomain_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    rateinst_nomain_testage_noprep <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 0)
    agecoefs_rateinst_nomain_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_nomain_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(rateinst_nomain_testage_noprep))[2:8,2]))
    ageplot_rateinst_nomain_noprep <- ggplot(agecoefs_rateinst_nomain_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_rateinst_nomain_all, ageplot_rateinst_nomain_noprep, cols=1)
```

These plot both suggest that the rate of instantaneous partners is higher for men aged 35-39. To further explore the association with age, we will include age as a dummy variable, grouping together men in age groups 40-49 and 50-59.

The results of the regression analyses using data from the full sample are:
```{r rateinst_nomain_all, eval=TRUE, error=TRUE}

##FULL SAMPLE##
#Main effects
  rateinst_nomain_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 0)

 #Interactions
  rateinst_nomain_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample, subset = degree_main %in% 0)
  
  results_rateinst_nomain <- compare.models(rateinst_nomain_full, rateinst_nomain_noregion, rateinst_nomain_norace, rateinst_nomain_noage, rateinst_nomain_full_withint, rateinst_nomain_noraceXreg, rateinst_nomain_noageXreg, rateinst_nomain_noraceXage)
    results_rateinst_nomain
```

The results of the regression analyses excluding data from men who have used PrEP in the past 12 months or whose partners were using PrEP are:
```{r  rateinst_nomain_noprep, eval=TRUE, error=TRUE}
##No use of PrEP in the past 12 months##
 #Main effects
  rateinst_nomain_full_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noregion_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg,  data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_norace_noprep <- lm(rate_inst ~ age_cat_alt + region.bKC,  data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noage_noprep <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 0)

 #Interactions
  rateinst_nomain_full_withint_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noraceXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noageXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noraceXage_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep, subset = degree_main %in% 0)
  
  results_rateinst_nomain_noprep <- compare.models(rateinst_nomain_full_noprep, rateinst_nomain_noregion_noprep, rateinst_nomain_norace_noprep, rateinst_nomain_noage_noprep, rateinst_nomain_full_withint_noprep, rateinst_nomain_noraceXreg_noprep, rateinst_nomain_noageXreg_noprep, rateinst_nomain_noraceXage_noprep)
    results_rateinst_nomain_noprep
```

### Main partner
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins.
```{r}
#Figure out how to parameterize age
    
 #Full sample
    rateinst_main_testage_all <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 1)
    agecoefs_rateinst_main_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_main_testage_all$coefficients[2:8]), se = as.vector(coef(summary(rateinst_main_testage_all))[2:8,2]))
    ageplot_rateinst_main_all <- ggplot(agecoefs_rateinst_main_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    rateinst_main_testage_noprep <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)
    agecoefs_rateinst_main_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_main_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(rateinst_main_testage_noprep))[2:8,2]))
    ageplot_rateinst_main_noprep <- ggplot(agecoefs_rateinst_main_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_rateinst_main_all, ageplot_rateinst_main_noprep, cols=1)
    
```

In the full sample, this plot suggests that the rate of instantaneous partners increases with age through age 39 and subsequently decreases. The plot based on data excluding current and past 12-month PrEP users does not indicate any trend by age. However to be consistent with the approach taken above, we will include age as a dummy variable in both models, grouping together men in age groups 40-49 and 50-59.

The results of the regression analyses using data from the full sample are:
```{r rateinst_main_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  rateinst_main_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 1)
  rateinst_main_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample, subset = degree_main %in% 1)
  rateinst_main_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample, subset = degree_main %in% 1)
  rateinst_main_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 1)

 #Interactions
  rateinst_main_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 1)
  rateinst_main_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 1)
  rateinst_main_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 1)
  rateinst_main_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample, subset = degree_main %in% 1)
  
  results_rateinst_main <- compare.models(rateinst_main_full, rateinst_main_noregion, rateinst_main_norace, rateinst_main_noage, rateinst_main_full_withint, rateinst_main_noraceXreg, rateinst_main_noageXreg, rateinst_main_noraceXage)
    results_rateinst_main
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months or whose parters were using PrEP are:
```{r rateinst_main_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  rateinst_main_full_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noregion_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_norace_noprep <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noage_noprep <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)

 #Interactions
  rateinst_main_full_withint_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noraceXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noageXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noraceXage_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)
  
  results_rateinst_main_noprep <- compare.models(rateinst_main_full_noprep, rateinst_main_noregion_noprep, rateinst_main_norace_noprep, rateinst_main_noage_noprep, rateinst_main_full_withint_noprep, rateinst_main_noraceXreg_noprep, rateinst_main_noageXreg_noprep, rateinst_main_noraceXage_noprep)
    results_rateinst_main_noprep
```

### No persistent partners
The plots below shoe the ceofficients for age from a model adjusting for race/ethnicity and region, with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
   #Full sample
    rateinst_nopers_testage_all <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% "None")
    agecoefs_rateinst_nopers_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_nopers_testage_all$coefficients[2:8]), se = as.vector(coef(summary(rateinst_nopers_testage_all))[2:8,2]))
    ageplot_rateinst_nopers_all <- ggplot(agecoefs_rateinst_nopers_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    rateinst_nopers_testage_noprep <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")
    agecoefs_rateinst_nopers_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_nopers_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(rateinst_nopers_testage_noprep))[2:8,2]))
    ageplot_rateinst_nopers_noprep <- ggplot(agecoefs_rateinst_nopers_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_rateinst_nopers_all, ageplot_rateinst_nopers_noprep, cols=1)
    
```

These data from both the full sample and the sample restricted to men who have not recently used PrEP and whose partners are not using PrEP suggest that the rate of instantaneous partners is higher for men aged 35-39. We will further explore the association with age, including age as a dummy variable, grouping together men in age groups 40-49 and 50-59.

The results of the regression analyses using data from the full sample are:
```{r rateinst_nopers_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  rateinst_nopers_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% "None")

 #Interactions
  rateinst_nopers_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample, subset = degreecat_cas %in% "None")
  
  results_rateinst_nopers <- compare.models(rateinst_nopers_full, rateinst_nopers_noregion, rateinst_nopers_norace, rateinst_nopers_noage, rateinst_nopers_full_withint, rateinst_nopers_noraceXreg, rateinst_nopers_noageXreg, rateinst_nopers_noraceXage)
    results_rateinst_nopers
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months or whose parters were using PrEP are:
```{r rateinst_nopers_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  rateinst_nopers_full_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noregion_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_norace_noprep <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noage_noprep <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")

 #Interactions
  rateinst_nopers_full_withint_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noraceXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noageXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noraceXage_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  
  results_rateinst_nopers_noprep <- compare.models(rateinst_nopers_full_noprep, rateinst_nopers_noregion_noprep, rateinst_nopers_norace_noprep, rateinst_nopers_noage_noprep, rateinst_nopers_full_withint_noprep, rateinst_nopers_noraceXreg_noprep, rateinst_nopers_noageXreg_noprep, rateinst_nopers_noraceXage_noprep)
    results_rateinst_nopers_noprep
```

### Any persistent partners
The plots below show the ceofficients for age from a model adjusting for race/ethnicity and region, with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
   #Full sample
    rateinst_anypers_testage_all <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
    agecoefs_rateinst_anypers_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_anypers_testage_all$coefficients[2:8]), se = as.vector(coef(summary(rateinst_anypers_testage_all))[2:8,2]))
    ageplot_rateinst_anypers_all <- ggplot(agecoefs_rateinst_anypers_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    rateinst_anypers_testage_noprep <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
    agecoefs_rateinst_anypers_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_anypers_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(rateinst_anypers_testage_noprep))[2:8,2]))
    ageplot_rateinst_anypers_noprep <- ggplot(agecoefs_rateinst_anypers_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_rateinst_anypers_all, ageplot_rateinst_anypers_noprep, cols=1)
    
```

The plot of coefficients from the model using data from the full sample suggests that the rate of instantaneous partners is higher for men aged 35-39. Among men who have not used PrEP in the past 12 months and whose partners are not on PrEP, the rate of instantaneous partners appears higher for men aged 50-54. To explore these associations further, we will include age as a dummy variable in subsequent analyses, grouping together men in age groups 40-49 and 50-59.

The results of the regression analyses using data from the full sample are:
```{r rateinst_anypers_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  rateinst_anypers_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))

 #Interactions
  rateinst_anypers_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  
  results_rateinst_anypers <- compare.models(rateinst_anypers_full, rateinst_anypers_noregion, rateinst_anypers_norace, rateinst_anypers_noage, rateinst_anypers_full_withint, rateinst_anypers_noraceXreg, rateinst_anypers_noageXreg, rateinst_anypers_noraceXage)
    results_rateinst_anypers
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months or whose parters were using PrEP are:
```{r rateinst_anypers_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  rateinst_anypers_full_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noregion_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_norace_noprep <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noage_noprep <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))

 #Interactions
  rateinst_anypers_full_withint_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noraceXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noageXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noraceXage_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  
  results_rateinst_anypers_noprep <- compare.models(rateinst_anypers_full_noprep, rateinst_anypers_noregion_noprep, rateinst_anypers_norace_noprep, rateinst_anypers_noage_noprep, rateinst_anypers_full_withint_noprep, rateinst_anypers_noraceXreg_noprep, rateinst_anypers_noageXreg_noprep, rateinst_anypers_noraceXage_noprep)
    results_rateinst_anypers_noprep
```

## Condom use
Data on condom use are restricted to dyads in which both the respondent and his partner were HIV-negative or of unknown status. This analysis includes data from all such partnerships, not just those that were ongoing.

### Main partners
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins.
```{r}
#Figure out how to parameterize age
    
 #Full sample
    condoms_main_testage_all <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    agecoefs_condoms_main_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_main_testage_all$coefficients[2:8]), se = as.vector(coef(summary(condoms_main_testage_all))[2:8,2]))
    ageplot_condoms_main_all <- ggplot(agecoefs_condoms_main_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    condoms_main_testage_noprep <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep_noalterprep)
    agecoefs_condoms_main_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_main_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(condoms_main_testage_noprep))[2:8,2]))
    ageplot_condoms_main_noprep <- ggplot(agecoefs_condoms_main_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_condoms_main_all, ageplot_condoms_main_noprep, cols=1)
```

These plots suggest that condom use in main partnerships is lower for men aged 35-49 (though not quite significantly so after excluding PrEP users). The number of respondents aged 40 and higher is somewhat small, so we will group ages 40-59 in 10-year bins in subsequent analyses. 

The results of the regression analyses using data from the full sample are:
```{r condoms_main_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  condoms_main_full <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample)
  condoms_main_noregion <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg, data=sample)
  condoms_main_norace <- lm(condoms_main ~ age_cat_alt + region.bKC, data=sample)
  condoms_main_noage <- lm(condoms_main ~ race_eth_m.reg + region.bKC, data=sample)
  
 #Interactions
  condoms_main_full_withint <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  condoms_main_noraceXreg <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  condoms_main_noageXreg <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  condoms_main_noraceXage <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_condoms_main <- compare.models(condoms_main_full, condoms_main_noregion, condoms_main_norace, condoms_main_noage, condoms_main_full_withint, condoms_main_noraceXreg, condoms_main_noageXreg, condoms_main_noraceXage)
    results_condoms_main
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months or whose parters were using PrEP are:
```{r condoms_main_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  condoms_main_full_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep_noalterprep)
  condoms_main_noregion_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg, data=sample_p12noprep_noalterprep)
  condoms_main_norace_noprep <- lm(condoms_main ~ age_cat_alt + region.bKC, data=sample_p12noprep_noalterprep)
  condoms_main_noage_noprep <- lm(condoms_main ~ race_eth_m.reg + region.bKC, data=sample_p12noprep_noalterprep)

 #Interactions
  condoms_main_full_withint_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep_noalterprep)
  condoms_main_noraceXreg_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep_noalterprep)
  condoms_main_noageXreg_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep_noalterprep)
  condoms_main_noraceXage_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep_noalterprep)
  
  results_condoms_main_noprep <- compare.models(condoms_main_full_noprep, condoms_main_noregion_noprep, condoms_main_norace_noprep, condoms_main_noage_noprep, condoms_main_full_withint_noprep, condoms_main_noraceXreg_noprep, condoms_main_noageXreg_noprep, condoms_main_noraceXage_noprep)
    results_condoms_main_noprep
```

### Persistent partners
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins.
```{r}
#Figure out how to parameterize age
    
 #Full sample
    condoms_pers_testage_all <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    agecoefs_condoms_pers_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_pers_testage_all$coefficients[2:8]), se = as.vector(coef(summary(condoms_pers_testage_all))[2:8,2]))
    ageplot_condoms_pers_all <- ggplot(agecoefs_condoms_pers_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    condoms_pers_testage_noprep <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep_noalterprep)
    agecoefs_condoms_pers_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_pers_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(condoms_pers_testage_noprep))[2:8,2]))
    ageplot_condoms_pers_noprep <- ggplot(agecoefs_condoms_pers_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_condoms_pers_all, ageplot_condoms_pers_noprep, cols=1)
```

These data do not suggest a clear pattern by age for condom use with persistent partners. We will not include age in models testing associations by race/ethnicity and region.

The results of the regression analyses using data from the full sample are:
```{r condoms_pers_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  condoms_pers_full <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample)
  condoms_pers_noregion <- lm(condoms_pers ~ race_eth_m.reg, data=sample)
  condoms_pers_norace <- lm(condoms_pers ~ region.bKC, data=sample)

 #Interactions
  condoms_pers_full_withint <- lm(condoms_pers ~ race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC, data=sample)
  condoms_pers_noraceXreg <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample)
  
  results_condoms_pers <- compare.models.noage(condoms_pers_full, condoms_pers_noregion, condoms_pers_norace, condoms_pers_full_withint, condoms_pers_noraceXreg)
  results_condoms_pers
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months or whose parters were using PrEP are:
```{r condoms_pers_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  condoms_pers_full_noprep <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample_p12noprep_noalterprep)
  condoms_pers_noregion_noprep <- lm(condoms_pers ~ race_eth_m.reg, data=sample_p12noprep_noalterprep)
  condoms_pers_norace_noprep <- lm(condoms_pers ~ region.bKC, data=sample_p12noprep_noalterprep)

 #Interactions
  condoms_pers_full_withint_noprep <- lm(condoms_pers ~ race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep_noalterprep)
  condoms_pers_noraceXreg_noprep <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample_p12noprep_noalterprep)
  
  results_condoms_pers_noprep <- compare.models.noage(condoms_pers_full_noprep, condoms_pers_noregion_noprep, condoms_pers_norace_noprep, condoms_pers_full_withint_noprep, condoms_pers_noraceXreg_noprep)
  results_condoms_pers_noprep
```

### Instantaneous partners
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins. When restricting to men who had not used PrEP in the past 12 months and whose partners were not taking PrEP, all `r sum(sample_p12noprep_noalterprep$age_cat %in% "45-49" & !is.na(sample_p12noprep_noalterprep$condoms_inst))` men aged 45-49 who reported on an instantaneous partner indicated that they used condoms, making this estimate highly unstable. We set limits to the y-axis of -4 to 4, which results in this data point being dropped due to having a very high point estimate and a wide confidence interval. 
```{r}
#Figure out how to parameterize age
    
 #Full sample
    condoms_inst_testage_all <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    agecoefs_condoms_inst_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_inst_testage_all$coefficients[2:8]), se = as.vector(coef(summary(condoms_inst_testage_all))[2:8,2]))
    ageplot_condoms_inst_all <- ggplot(agecoefs_condoms_inst_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background + ylim(-4, 4)

#Men who haven't used PrEP in the past 12 months
    condoms_inst_testage_noprep <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep_noalterprep)
    agecoefs_condoms_inst_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_inst_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(condoms_inst_testage_noprep))[2:8,2]))
    ageplot_condoms_inst_noprep <- ggplot(agecoefs_condoms_inst_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background + ylim(-4, 4)
    
    multiplot(ageplot_condoms_inst_all, ageplot_condoms_inst_noprep, cols=1)
```
 
The plots of these coefficients do not suggest that there is any meaningful pattern by age for the probability of condom use with instantaneous partners. As such, age will not be included in subsequent analyses.

The results of the regression analyses using data from the full sample are:
```{r condoms_inst_full}

##Full sample##
 #Main effects
  condoms_inst_full <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  condoms_inst_noregion <- glm(condoms_inst ~ race_eth_m.reg, family=binomial(link="logit"), data=sample)
  condoms_inst_norace <- glm(condoms_inst ~ region.bKC, family=binomial(link="logit"), data=sample)

 #Interactions
  condoms_inst_full_withint <- glm(condoms_inst ~ race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample)
  condoms_inst_noraceXreg <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  
  results_condoms_inst <- compare.models.noage(condoms_inst_full, condoms_inst_noregion, condoms_inst_norace, condoms_inst_full_withint, condoms_inst_noraceXreg)
  results_condoms_inst
  
```

The results of the regression analyses restricting the sample to men who had not used PrEP in the past 12 months and whose partners were not taking PrEP are:
```{r condoms_inst_noprep}

##No PrEP in the past 12 months##
 #Main effects
  condoms_inst_full_noprep <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep_noalterprep)
  condoms_inst_noregion_noprep <- glm(condoms_inst ~ race_eth_m.reg, family=binomial(link="logit"), data=sample_p12noprep_noalterprep)
  condoms_inst_norace_noprep <- glm(condoms_inst ~ region.bKC, family=binomial(link="logit"), data=sample_p12noprep_noalterprep)

 #Interactions
  condoms_inst_full_withint_noprep <- glm(condoms_inst ~ race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample_p12noprep_noalterprep)
  condoms_inst_noraceXreg_noprep <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep_noalterprep)
  
  results_condoms_inst_noprep <- compare.models.noage(condoms_inst_full_noprep, condoms_inst_noregion_noprep, condoms_inst_norace_noprep, condoms_inst_full_withint_noprep, condoms_inst_noraceXreg_noprep)
  results_condoms_inst_noprep
  
```

## Sex role
Sex role is categorized as exclusively bottom, exclusively top, or versatile, based on men's reported role in anal sex over the past 12 months. Responses of "mostly a bottom", "mostly a top", and "equally a bottom and a top" are categorized as versatile. For this analysis, dichotomous indicators was constructed to measure whether men report exclusively topping, exclusively bottoming, or a versatile sex role.
```{r}
  #Define indicators
  sample$position_top <- ifelse(sample$position_cat=="Exclusively top", 1, ifelse(!is.na(sample$position_cat), 0, NA))
  sample$position_bottom <- ifelse(sample$position_cat=="Exclusively bottom", 1, ifelse(!is.na(sample$position_cat), 0, NA))
  sample$position_versatile <- ifelse(sample$position_cat=="Versatile", 1, ifelse(!is.na(sample$position_cat), 0, NA))
  
  sample_p12noprep$position_top <- ifelse(sample_p12noprep$position_cat=="Exclusively top", 1, ifelse(!is.na(sample_p12noprep$position_cat), 0, NA))
  sample_p12noprep$position_bottom <- ifelse(sample_p12noprep$position_cat=="Exclusively bottom", 1, ifelse(!is.na(sample_p12noprep$position_cat), 0, NA))
  sample_p12noprep$position_versatile <- ifelse(sample_p12noprep$position_cat=="Versatile", 1, ifelse(!is.na(sample_p12noprep$position_cat), 0, NA))
  
```

### Exclusively topping
To inform parameterization of age in models exploring heterogeneity in the proportion of men who report exclusively topping, we will plot the ceofficients from a model with age input as a dummy variable with 5-year age bins, adjusting for race/ethnicity and region.

```{r}
#Figure out how to parameterize age
 #Full sample
    position_top_testage_all <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    agecoefs_position_top_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_top_testage_all$coefficients[2:8]), se = as.vector(coef(summary(position_top_testage_all))[2:8,2]))
    ageplot_position_top_all <- ggplot(agecoefs_position_top_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    position_top_testage_noprep <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
    agecoefs_position_top_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_top_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(position_top_testage_noprep))[2:8,2]))
    ageplot_position_top_noprep <- ggplot(agecoefs_position_top_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_position_top_all, ageplot_position_top_noprep, cols=1)

```

In both models, although the proportion of men reporting that they are exclusive tops seems to increase through age 44, it then fluctuates for older age groups. In subsequent models, we will represent age as a categorical variable with ages 40-59 binned in 10-year groups.

The results of the regression analyses using data from the full sample are:
```{r topping_full}

##Full sample##
 #Main effects
  top_full <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  top_noregion <- glm(position_top ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  top_norace <- glm(position_top ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample)
  top_noage <-  glm(position_top ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  
 #Interactions
  top_full_withint <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  top_noraceXreg <- glm(position_top ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  top_noraceXage <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  top_noageXreg <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  
  results_topping <- compare.models(top_full, top_noregion, top_norace, top_noage, top_full_withint, top_noraceXreg, top_noageXreg, top_noraceXage)
  results_topping
  
```

The results of the regression analyses restricting the sample to men who had not used PrEP in the past 12 months and whose partners were not taking PrEP are:
```{r topping_noprep}

##No PrEP in the past 12 months##
 #Main effects
  top_full_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  top_noregion_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample_p12noprep)
  top_norace_noprep <- glm(position_top ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  top_noage_noprep <-  glm(position_top ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  
 #Interactions
  top_full_withint_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  top_noraceXreg_noprep <- glm(position_top ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  top_noraceXage_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  top_noageXreg_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  
  results_topping_noprep <- compare.models(top_full_noprep, top_noregion_noprep, top_norace_noprep, top_noage_noprep, top_full_withint_noprep, top_noraceXreg_noprep, top_noageXreg_noprep, top_noraceXage_noprep)
  results_topping_noprep
  
```

### Exclusively bottoming
As above, to inform parameterization of age in models exploring heterogeneity in the proportion of men who report exclusively bottoming, we will plot the ceofficients from a model with age input as a dummy variable with 5-year age bins, adjusting for race/ethnicity and region.
```{r}
#Figure out how to parameterize age
 #Full sample
    position_bottom_testage_all <- glm(position_bottom ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    agecoefs_position_bottom_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_bottom_testage_all$coefficients[2:8]), se = as.vector(coef(summary(position_bottom_testage_all))[2:8,2]))
    ageplot_position_bottom_all <- ggplot(agecoefs_position_bottom_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    position_bottom_testage_noprep <- glm(position_bottom ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
    agecoefs_position_bottom_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_bottom_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(position_bottom_testage_noprep))[2:8,2]))
    ageplot_position_bottom_noprep <- ggplot(agecoefs_position_bottom_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_position_bottom_all, ageplot_position_bottom_noprep, cols=1)

```

In the full sample and the subset excluding men who used PrEP in the past 12 months, the proportion of men reporting that they are exclusive bottoms seems to drop for men aged 35-39 and then increase again. To further explore this effect, in subsequent models, we will represent age as a categorical variable with ages 40-59 binned in 10-year groups.

The results of the regression analyses using data from the full sample are:
```{r bottoming_full}

##Full sample##
 #Main effects
  bottom_full <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  bottom_noregion <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  bottom_norace <- glm(position_bottom ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample)
  bottom_noage <-  glm(position_bottom ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  
 #Interactions
  bottom_full_withint <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  bottom_noraceXreg <- glm(position_bottom ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  bottom_noraceXage <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  bottom_noageXreg <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  
  results_bottoming <- compare.models(bottom_full, bottom_noregion, bottom_norace, bottom_noage, bottom_full_withint, bottom_noraceXreg, bottom_noageXreg, bottom_noraceXage)
  results_bottoming
  
```

The results of the regression analyses restricting the sample to men who had not used PrEP in the past 12 months and whose partners were not taking PrEP are:
```{r bottoming_noprep}

##No PrEP in the past 12 months##
 #Main effects
  bottom_full_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noregion_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_norace_noprep <- glm(position_bottom ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noage_noprep <-  glm(position_bottom ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  
 #Interactions
  bottom_full_withint_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noraceXreg_noprep <- glm(position_bottom ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noraceXage_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noageXreg_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  
  results_bottoming_noprep <- compare.models(bottom_full_noprep, bottom_noregion_noprep, bottom_norace_noprep, bottom_noage_noprep, bottom_full_withint_noprep, bottom_noraceXreg_noprep, bottom_noageXreg_noprep, bottom_noraceXage_noprep)
  results_bottoming_noprep
  
```

### Versatile
To inform parameterization of age in models exploring heterogeneity in the proportion of men who report being versatile in their anal sex role, we will plot the ceofficients from a model with age input as a dummy variable with 5-year age bins, adjusting for race/ethnicity and region.

```{r}
 #Figure out how to parameterize age
  #Full sample
    position_versatile_testage_all <- glm(position_versatile ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    agecoefs_position_versatile_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_versatile_testage_all$coefficients[2:8]), se = as.vector(coef(summary(position_versatile_testage_all))[2:8,2]))
    ageplot_position_versatile_all <- ggplot(agecoefs_position_versatile_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    position_versatile_testage_noprep <- glm(position_versatile ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
    agecoefs_position_versatile_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_versatile_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(position_versatile_testage_noprep))[2:8,2]))
    ageplot_position_versatile_noprep <- ggplot(agecoefs_position_versatile_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_position_versatile_all, ageplot_position_versatile_noprep, cols=1)

```

These data do not suggest any clear trend by age. However, because sex role will be represented in the model using one 3-level variable for exclusively top, exclusively bottom, or versatile, we will include age in the models below as a categorical variable to be consistent with the approach taken for the indicators of exclusively topping and exclusively bottoming.

The results of the regression analyses using data from the full sample are:
```{r versatile_full}
 
##Full sample##
 #Main effects
  versatile_full <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  versatile_noregion <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  versatile_norace <- glm(position_versatile ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample)
  versatile_noage <-  glm(position_versatile ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  
 #Interactions
  versatile_full_withint <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  versatile_noraceXreg <- glm(position_versatile ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  versatile_noraceXage <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  versatile_noageXreg <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  
  results_versatile <- compare.models(versatile_full, versatile_noregion, versatile_norace, versatile_noage, versatile_full_withint, versatile_noraceXreg, versatile_noageXreg, versatile_noraceXage)
  results_versatile
  
```

The results of the regression analyses restricting the sample to men who had not used PrEP in the past 12 months and whose partners were not taking PrEP are:
```{r versatile_noprep}

##No PrEP in the past 12 months##
 #Main effects
  versatile_full_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noregion_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_norace_noprep <- glm(position_versatile ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noage_noprep <-  glm(position_versatile ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  
 #Interactions
  versatile_full_withint_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noraceXreg_noprep <- glm(position_versatile ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noraceXage_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noageXreg_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  
  results_versatile_noprep <- compare.models(versatile_full_noprep, versatile_noregion_noprep, versatile_norace_noprep, versatile_noage_noprep, versatile_full_withint_noprep, versatile_noraceXreg_noprep, versatile_noageXreg_noprep, versatile_noraceXage_noprep)
  results_versatile_noprep
  
```
