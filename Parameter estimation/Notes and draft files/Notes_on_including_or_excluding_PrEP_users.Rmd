# Exploring the effects of including/excluding PrEP users in estimation of behavioral parameters
This file examines the effects of including or excluding data from men who have used PrEP in examining associations with condom use, the rate of instantaneous partnerships, and sex role. These behaviors may change with PrEP use due to risk compensation, such that including data from PrEP users may over-estimate risk. But excluding PrEP users also means excluding high-risk men, as PrEP use is targeted to those with higher risk behaviors.
```{r, include=FALSE}
####################################################################################
# Setup
####################################################################################
#-----------------------------------------------------------------------------------
# Load packages
#-----------------------------------------------------------------------------------

    library("tidyverse")
    library("knitr")
    library("data.table")
    library("lmtest")
    library("kableExtra")
    library("logbin")

#-----------------------------------------------------------------------------------
# Knitr options
#-----------------------------------------------------------------------------------
opts_chunk$set(echo=FALSE, message=FALSE, warning=TRUE, error=TRUE, fig.align = "center")
options(knitr.table.format = "html") 

#-----------------------------------------------------------------------------------
# Plot settings
#-----------------------------------------------------------------------------------
#save plot settings for white background and light grey lines and darkening the colors a bit
plot_background <- theme(panel.background = element_rect(fill="white", colour = "black")) + theme(panel.grid.major = element_line(colour = "grey90"))
darken_color <- scale_colour_hue(l=50)
theme_title <- theme(plot.title = element_text(hjust = 0.5, size=12)) 
        
#-----------------------------------------------------------------------------------
# Load data
#-----------------------------------------------------------------------------------
setwd("/homes/dpwhite/R/GitHub Repos/WHAMP/Parameter estimation")
load(file="Data/InternetSurveySample.Rdata")
load(file="Data/InternetSurveySample_allages.Rdata")

#-----------------------------------------------------------------------------------
# Define alternate age categorization
#-----------------------------------------------------------------------------------
   sample$age_chunks <-  cut(sample$age, c(17, 29, 39, 44, 59), labels=c("18-29", "30-39", "40-49", "50-59"))   
    sample$age_cat_alt <- cut(sample$age, c(17, 24, 29, 34, 39, 49, 59), labels=c("18-24", "25-29", "30-34", "35-39", "40-49", "50-59"))

#-----------------------------------------------------------------------------------
# Define the subset of the sample that excludes men who are using or used PrEP in the past 12 months
#-----------------------------------------------------------------------------------
    sample_p12noprep <- sample %>% filter(!(prep_use_r %in% "Currently taking PrEP") & !(monthsago_lastprep %in% c(0:12)))
    
#----------------------------------------------------------------------------------
# Define multiplot function
#_---------------------------------------------------------------------------------
        multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
            library(grid)
            
            # Make a list from the ... arguments and plotlist
            plots <- c(list(...), plotlist)
            
            numPlots = length(plots)
            
            # If layout is NULL, then use 'cols' to determine layout
            if (is.null(layout)) {
                # Make the panel
                # ncol: Number of columns of plots
                # nrow: Number of rows needed, calculated from # of cols
                layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                                 ncol = cols, nrow = ceiling(numPlots/cols))
            }
            
            if (numPlots==1) {
                print(plots[[1]])
                
            } else {
                # Set up the page
                grid.newpage()
                pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
                
                # Make each plot, in the correct location
                for (i in 1:numPlots) {
                    # Get the i,j matrix positions of the regions that contain this subplot
                    matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
                    
                    print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                                    layout.pos.col = matchidx$col))
                }
            }
        }

#-----------------------------------------------------------------------------------
# Write function to streamline analyses
#-----------------------------------------------------------------------------------
#Function to plot the coefficients for age
plot.age.coefs <- function(full) {
    agecoefs <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(full$coefficients[2:8]), se = as.vector(coef(summary(full))[2:8,2]))
    plot <- ggplot(agecoefs, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% confidence intervals for age")
    return(plot) + theme_title + plot_background
}

#Function to get likelihood ratio tests
    #Outcomes for which we are looking at age, race, and region
    compare.models <- function(full, noreg, norace, noage, full_withint, noraceXreg, noageXreg, noraceXage) {
        lrt_region <- lrtest(full, noreg)
        lrt_race <- lrtest(full, norace)
        lrt_age <- lrtest(full, noage)
        lrt_summary_main <- cbind.data.frame("Variable" = c("Region", "Race", "Age"), "pvalue" = c(round(lrt_region$'Pr(>Chisq)'[2], 4), round(lrt_race$'Pr(>Chisq)'[2], 4), round(lrt_age$'Pr(>Chisq)'[2], 4)))
        lrt_summary_main$sig <- ifelse(lrt_summary_main$pvalue<0.001, "***", ifelse(lrt_summary_main$pvalue<0.01, "**", ifelse(lrt_summary_main$pvalue<0.05, "*", "")))
        
        lrt_raceXreg <- lrtest(full_withint, noraceXreg)
        lrt_ageXreg <- lrtest(full_withint, noageXreg)
        lrt_raceXage <- lrtest(full_withint, noraceXage)
        lrt_summary_int <- cbind.data.frame("Variable" = c("Race by region", "Age by region", "Race by age"), "pvalue" = c(round(lrt_raceXreg$'Pr(>Chisq)'[2], 4), round(lrt_ageXreg$'Pr(>Chisq)'[2], 4), round(lrt_raceXage$'Pr(>Chisq)'[2], 4)))
        lrt_summary_int$sig <-  ifelse(lrt_summary_int$pvalue<0.001, "***", ifelse(lrt_summary_int$pvalue<0.01, "**", ifelse(lrt_summary_int$pvalue<0.05, "*", "")))
    
        #results <- list(summary(full), lrt_summary_main, summary(full_withint), lrt_summary_int)
        results <- list(lrt_summary_main, lrt_summary_int)

        return(results)
    }

#Outcomes for which we are looking only at race and region
    compare.models.noage <- function(full, noreg, norace, full_withint, noraceXreg) {
        lrt_region <- lrtest(full, noreg)
        lrt_race <- lrtest(full, norace)
        lrt_summary_main <- cbind.data.frame("Variable" = c("Region", "Race", "Age"), "pvalue" = as.numeric(c(round(lrt_region$'Pr(>Chisq)'[2], 4), round(lrt_race$'Pr(>Chisq)'[2], 4), "")))
        lrt_summary_main$sig <- ifelse(lrt_summary_main$pvalue<0.001, "***", ifelse(lrt_summary_main$pvalue<0.01, "**", ifelse(lrt_summary_main$pvalue<0.05, "*", "")))
        
        lrt_raceXreg <- lrtest(full_withint, noraceXreg)
        lrt_summary_int <- cbind.data.frame("Variable" = c("Race by region", "Age by region", "Race by age"), "pvalue" = as.numeric(c(round(lrt_raceXreg$'Pr(>Chisq)'[2], 4), "", "")))
        lrt_summary_int$sig <-  ifelse(lrt_summary_int$pvalue<0.001, "***", ifelse(lrt_summary_int$pvalue<0.01, "**", ifelse(lrt_summary_int$pvalue<0.05, "*", "")))
    
        #results <- list(summary(full), lrt_summary_main, summary(full_withint), lrt_summary_int)
        results <- list(lrt_summary_main, lrt_summary_int)
        
        return(results)
    }

```

## Rate of instantaneous partners
This analysis looks at heterogeneity in the rate of one-time partnerships separately for men who have 0 main, those who have 1 main, those who have 0 persistent, and those who have one or more persistent partnerships. __In this analysis, we compare the findings from models including and excluding data from men who have ever used PrEP.__

### No main partners
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins.
```{r}
#Figure out how to parameterize age

 #Full sample
    rateinst_nomain_testage_all <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 0)
    agecoefs_rateinst_nomain_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_nomain_testage_all$coefficients[2:8]), se = as.vector(coef(summary(rateinst_nomain_testage_all))[2:8,2]))
    ageplot_rateinst_nomain_all <- ggplot(agecoefs_rateinst_nomain_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    rateinst_nomain_testage_noprep <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 0)
    agecoefs_rateinst_nomain_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_nomain_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(rateinst_nomain_testage_noprep))[2:8,2]))
    ageplot_rateinst_nomain_noprep <- ggplot(agecoefs_rateinst_nomain_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_rateinst_nomain_all, ageplot_rateinst_nomain_noprep, cols=1)
```

These plot both suggest that the rate of instantaneous partners is higher for men aged 35-39. To further explore the association with age, we will include age as a dummy variable, grouping together men in age groups 40-49 and 50-59.

The results of the regression analyses using data from the full sample are:
```{r rateinst_nomain_all, eval=TRUE, error=TRUE}

##FULL SAMPLE##
#Main effects
  rateinst_nomain_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 0)

 #Interactions
  rateinst_nomain_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 0)
  rateinst_nomain_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample, subset = degree_main %in% 0)
  
  results_rateinst_nomain <- compare.models(rateinst_nomain_full, rateinst_nomain_noregion, rateinst_nomain_norace, rateinst_nomain_noage, rateinst_nomain_full_withint, rateinst_nomain_noraceXreg, rateinst_nomain_noageXreg, rateinst_nomain_noraceXage)
    results_rateinst_nomain
```

The results of the regression analyses excluding data from men who have used PrEP in the past 12 months are:
```{r  rateinst_nomain_noprep, eval=TRUE, error=TRUE}
##No use of PrEP in the past 12 months##
 #Main effects
  rateinst_nomain_full_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noregion_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg,  data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_norace_noprep <- lm(rate_inst ~ age_cat_alt + region.bKC,  data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noage_noprep <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 0)

 #Interactions
  rateinst_nomain_full_withint_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noraceXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noageXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 0)
  rateinst_nomain_noraceXage_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep, subset = degree_main %in% 0)
  
  results_rateinst_nomain_noprep <- compare.models(rateinst_nomain_full_noprep, rateinst_nomain_noregion_noprep, rateinst_nomain_norace_noprep, rateinst_nomain_noage_noprep, rateinst_nomain_full_withint_noprep, rateinst_nomain_noraceXreg_noprep, rateinst_nomain_noageXreg_noprep, rateinst_nomain_noraceXage_noprep)
    results_rateinst_nomain_noprep
```

### Main partner
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins.
```{r}
#Figure out how to parameterize age
    
 #Full sample
    rateinst_main_testage_all <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 1)
    agecoefs_rateinst_main_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_main_testage_all$coefficients[2:8]), se = as.vector(coef(summary(rateinst_main_testage_all))[2:8,2]))
    ageplot_rateinst_main_all <- ggplot(agecoefs_rateinst_main_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    rateinst_main_testage_noprep <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)
    agecoefs_rateinst_main_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_main_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(rateinst_main_testage_noprep))[2:8,2]))
    ageplot_rateinst_main_noprep <- ggplot(agecoefs_rateinst_main_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_rateinst_main_all, ageplot_rateinst_main_noprep, cols=1)
    
```

In the full sample, this plot suggests that the rate of instantaneous partners increases with age through age 39 and subsequently decreases. The plot based on data excluding current and past 12-month PrEP users does not indicate any trend by age. However to be consistent with the approach taken above, we will include age as a dummy variable in both models, grouping together men in age groups 40-49 and 50-59.

The results of the regression analyses using data from the full sample are:
```{r rateinst_main_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  rateinst_main_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 1)
  rateinst_main_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample, subset = degree_main %in% 1)
  rateinst_main_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample, subset = degree_main %in% 1)
  rateinst_main_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample, subset = degree_main %in% 1)

 #Interactions
  rateinst_main_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 1)
  rateinst_main_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 1)
  rateinst_main_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degree_main %in% 1)
  rateinst_main_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample, subset = degree_main %in% 1)
  
  results_rateinst_main <- compare.models(rateinst_main_full, rateinst_main_noregion, rateinst_main_norace, rateinst_main_noage, rateinst_main_full_withint, rateinst_main_noraceXreg, rateinst_main_noageXreg, rateinst_main_noraceXage)
    results_rateinst_main
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months are:
```{r rateinst_main_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  rateinst_main_full_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noregion_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_norace_noprep <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noage_noprep <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)

 #Interactions
  rateinst_main_full_withint_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noraceXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noageXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degree_main %in% 1)
  rateinst_main_noraceXage_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep, subset = degree_main %in% 1)
  
  results_rateinst_main_noprep <- compare.models(rateinst_main_full_noprep, rateinst_main_noregion_noprep, rateinst_main_norace_noprep, rateinst_main_noage_noprep, rateinst_main_full_withint_noprep, rateinst_main_noraceXreg_noprep, rateinst_main_noageXreg_noprep, rateinst_main_noraceXage_noprep)
    results_rateinst_main_noprep
```

### No persistent partners
The plots below shoe the ceofficients for age from a model adjusting for race/ethnicity and region, with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
   #Full sample
    rateinst_nopers_testage_all <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% "None")
    agecoefs_rateinst_nopers_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_nopers_testage_all$coefficients[2:8]), se = as.vector(coef(summary(rateinst_nopers_testage_all))[2:8,2]))
    ageplot_rateinst_nopers_all <- ggplot(agecoefs_rateinst_nopers_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    rateinst_nopers_testage_noprep <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")
    agecoefs_rateinst_nopers_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_nopers_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(rateinst_nopers_testage_noprep))[2:8,2]))
    ageplot_rateinst_nopers_noprep <- ggplot(agecoefs_rateinst_nopers_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_rateinst_nopers_all, ageplot_rateinst_nopers_noprep, cols=1)
    
```

These data from both the full sample and the sample restricted to men who have not recently used PrEP suggest that the rate of instantaneous partners is higher for men aged 35-39. We will further explore the association with age, including age as a dummy variable, grouping together men in age groups 40-49 and 50-59.

The results of the regression analyses using data from the full sample are:
```{r rateinst_nopers_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  rateinst_nopers_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% "None")

 #Interactions
  rateinst_nopers_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% "None")
  rateinst_nopers_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample, subset = degreecat_cas %in% "None")
  
  results_rateinst_nopers <- compare.models(rateinst_nopers_full, rateinst_nopers_noregion, rateinst_nopers_norace, rateinst_nopers_noage, rateinst_nopers_full_withint, rateinst_nopers_noraceXreg, rateinst_nopers_noageXreg, rateinst_nopers_noraceXage)
    results_rateinst_nopers
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months are:
```{r rateinst_nopers_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  rateinst_nopers_full_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noregion_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_norace_noprep <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noage_noprep <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")

 #Interactions
  rateinst_nopers_full_withint_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noraceXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noageXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  rateinst_nopers_noraceXage_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% "None")
  
  results_rateinst_nopers_noprep <- compare.models(rateinst_nopers_full_noprep, rateinst_nopers_noregion_noprep, rateinst_nopers_norace_noprep, rateinst_nopers_noage_noprep, rateinst_nopers_full_withint_noprep, rateinst_nopers_noraceXreg_noprep, rateinst_nopers_noageXreg_noprep, rateinst_nopers_noraceXage_noprep)
    results_rateinst_nopers_noprep
```

### Any persistent partners
The plots below shoe the ceofficients for age from a model adjusting for race/ethnicity and region, with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
   #Full sample
    rateinst_anypers_testage_all <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
    agecoefs_rateinst_anypers_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_anypers_testage_all$coefficients[2:8]), se = as.vector(coef(summary(rateinst_anypers_testage_all))[2:8,2]))
    ageplot_rateinst_anypers_all <- ggplot(agecoefs_rateinst_anypers_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    rateinst_anypers_testage_noprep <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
    agecoefs_rateinst_anypers_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(rateinst_anypers_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(rateinst_anypers_testage_noprep))[2:8,2]))
    ageplot_rateinst_anypers_noprep <- ggplot(agecoefs_rateinst_anypers_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_rateinst_anypers_all, ageplot_rateinst_anypers_noprep, cols=1)
    
```

The plot of coefficients from the model using data from the full smaple suggests that teh rate of instantaneous partners is higher for men aged 35-39. Among men who have not used PrEP in the past 12 months, the rate of instantaneous partners appears higher for men aged 50-54. To explore these associations further, we will include age as a dummy variable in subsequent analyses, grouping together men in age groups 40-49 and 50-59.

The results of the regression analyses using data from the full sample are:
```{r rateinst_anypers_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  rateinst_anypers_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))

 #Interactions
  rateinst_anypers_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample, subset = degreecat_cas %in% c("One", "Two or more"))
  
  results_rateinst_anypers <- compare.models(rateinst_anypers_full, rateinst_anypers_noregion, rateinst_anypers_norace, rateinst_anypers_noage, rateinst_anypers_full_withint, rateinst_anypers_noraceXreg, rateinst_anypers_noageXreg, rateinst_anypers_noraceXage)
    results_rateinst_anypers
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months are:
```{r rateinst_anypers_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  rateinst_anypers_full_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noregion_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_norace_noprep <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noage_noprep <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))

 #Interactions
  rateinst_anypers_full_withint_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noraceXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noageXreg_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  rateinst_anypers_noraceXage_noprep <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep, subset = degreecat_cas %in% c("One", "Two or more"))
  
  results_rateinst_anypers_noprep <- compare.models(rateinst_anypers_full_noprep, rateinst_anypers_noregion_noprep, rateinst_anypers_norace_noprep, rateinst_anypers_noage_noprep, rateinst_anypers_full_withint_noprep, rateinst_anypers_noraceXreg_noprep, rateinst_anypers_noageXreg_noprep, rateinst_anypers_noraceXage_noprep)
    results_rateinst_anypers_noprep
```

## Condom use
Data on condom use are restricted to dyads in which both the respondent and his partner were HIV-negative or of unknown status. This analysis includes data from all such partnerships, not just those that were ongoing.

### Main partners
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins.
```{r}
#Figure out how to parameterize age
    
 #Full sample
    condoms_main_testage_all <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    agecoefs_condoms_main_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_main_testage_all$coefficients[2:8]), se = as.vector(coef(summary(condoms_main_testage_all))[2:8,2]))
    ageplot_condoms_main_all <- ggplot(agecoefs_condoms_main_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    condoms_main_testage_noprep <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep)
    agecoefs_condoms_main_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_main_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(condoms_main_testage_noprep))[2:8,2]))
    ageplot_condoms_main_noprep <- ggplot(agecoefs_condoms_main_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_condoms_main_all, ageplot_condoms_main_noprep, cols=1)
```

These plots suggest that condom use in main partnerships is lower for men aged 35-49. The number of respondents aged 40 and higher is somewhat small, so we will group ages 40-59 in 10-year bins in subsequent analyses. 

The results of the regression analyses using data from the full sample are:
```{r condoms_main_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  condoms_main_full <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample)
  condoms_main_noregion <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg, data=sample)
  condoms_main_norace <- lm(condoms_main ~ age_cat_alt + region.bKC, data=sample)
  condoms_main_noage <- lm(condoms_main ~ race_eth_m.reg + region.bKC, data=sample)
  
 #Interactions
  condoms_main_full_withint <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  condoms_main_noraceXreg <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  condoms_main_noageXreg <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  condoms_main_noraceXage <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_condoms_main <- compare.models(condoms_main_full, condoms_main_noregion, condoms_main_norace, condoms_main_noage, condoms_main_full_withint, condoms_main_noraceXreg, condoms_main_noageXreg, condoms_main_noraceXage)
    results_condoms_main
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months are:
```{r condoms_main_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  condoms_main_full_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample_p12noprep)
  condoms_main_noregion_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg, data=sample_p12noprep)
  condoms_main_norace_noprep <- lm(condoms_main ~ age_cat_alt + region.bKC, data=sample_p12noprep)
  condoms_main_noage_noprep <- lm(condoms_main ~ race_eth_m.reg + region.bKC, data=sample_p12noprep)

 #Interactions
  condoms_main_full_withint_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep)
  condoms_main_noraceXreg_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep)
  condoms_main_noageXreg_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample_p12noprep)
  condoms_main_noraceXage_noprep <- lm(condoms_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep)
  
  results_condoms_main_noprep <- compare.models(condoms_main_full_noprep, condoms_main_noregion_noprep, condoms_main_norace_noprep, condoms_main_noage_noprep, condoms_main_full_withint_noprep, condoms_main_noraceXreg_noprep, condoms_main_noageXreg_noprep, condoms_main_noraceXage_noprep)
    results_condoms_main_noprep
```

### Persistent partners
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins.
```{r}
#Figure out how to parameterize age
    
 #Full sample
    condoms_pers_testage_all <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    agecoefs_condoms_pers_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_pers_testage_all$coefficients[2:8]), se = as.vector(coef(summary(condoms_pers_testage_all))[2:8,2]))
    ageplot_condoms_pers_all <- ggplot(agecoefs_condoms_pers_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    condoms_pers_testage_noprep <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample_p12noprep)
    agecoefs_condoms_pers_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_pers_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(condoms_pers_testage_noprep))[2:8,2]))
    ageplot_condoms_pers_noprep <- ggplot(agecoefs_condoms_pers_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_condoms_pers_all, ageplot_condoms_pers_noprep, cols=1)
```

These data do not suggest a clear pattern by age for condom use with persistent partners. We will not include age in models testing associations by race/ethnicity and region.

The results of the regression analyses using data from the full sample are:
```{r condoms_pers_full, eval=TRUE, error=TRUE}

##Full sample##
 #Main effects
  condoms_pers_full <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample)
  condoms_pers_noregion <- lm(condoms_pers ~ race_eth_m.reg, data=sample)
  condoms_pers_norace <- lm(condoms_pers ~ region.bKC, data=sample)

 #Interactions
  condoms_pers_full_withint <- lm(condoms_pers ~ race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC, data=sample)
  condoms_pers_noraceXreg <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample)
  
  results_condoms_pers <- compare.models.noage(condoms_pers_full, condoms_pers_noregion, condoms_pers_norace, condoms_pers_full_withint, condoms_pers_noraceXreg)
  results_condoms_pers
```

The results of the regression analyses excluding men who had used PrEP in the past 12 months are:
```{r condoms_pers_noprep, eval=TRUE, error=TRUE}

##No use of PrEP in the past 12 months##
 #Main effects
  condoms_pers_full_noprep <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample_p12noprep)
  condoms_pers_noregion_noprep <- lm(condoms_pers ~ race_eth_m.reg, data=sample_p12noprep)
  condoms_pers_norace_noprep <- lm(condoms_pers ~ region.bKC, data=sample_p12noprep)

 #Interactions
  condoms_pers_full_withint_noprep <- lm(condoms_pers ~ race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC, data=sample_p12noprep)
  condoms_pers_noraceXreg_noprep <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample_p12noprep)
  
  results_condoms_pers_noprep <- compare.models.noage(condoms_pers_full_noprep, condoms_pers_noregion_noprep, condoms_pers_norace_noprep, condoms_pers_full_withint_noprep, condoms_pers_noraceXreg_noprep)
  results_condoms_pers_noprep
```

### Instantaneous partners
We first look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins. When restricting to men who had not used PrEP in the past 12 months, all 7 men aged 45-49 who reported on an instantaneous partner indicated that they used condoms, making this estimate highly unstable. We set limits to the y-axis of -3 to 3, which results in this data point being dropped due to having a very high point estimate and a wide confidence interval. 
```{r}
#Figure out how to parameterize age
    
 #Full sample
    condoms_inst_testage_all <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    agecoefs_condoms_inst_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_inst_testage_all$coefficients[2:8]), se = as.vector(coef(summary(condoms_inst_testage_all))[2:8,2]))
    ageplot_condoms_inst_all <- ggplot(agecoefs_condoms_inst_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background + ylim(-3, 3)

#Men who haven't used PrEP in the past 12 months
    condoms_inst_testage_noprep <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
    agecoefs_condoms_inst_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(condoms_inst_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(condoms_inst_testage_noprep))[2:8,2]))
    ageplot_condoms_inst_noprep <- ggplot(agecoefs_condoms_inst_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background + ylim(-3, 3)
    
    multiplot(ageplot_condoms_inst_all, ageplot_condoms_inst_noprep, cols=1)
```
 
The plots of these coefficients do not suggest that there is any meaningful pattern by age for the probability of condom use with instantaneous partners. As such, age will not be included in subsequent analyses.

The results of the regression analyses using data from the full sample are:
```{r condoms_inst_full}

##Full sample##
 #Main effects
  condoms_inst_full <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  condoms_inst_noregion <- glm(condoms_inst ~ race_eth_m.reg, family=binomial(link="logit"), data=sample)
  condoms_inst_norace <- glm(condoms_inst ~ region.bKC, family=binomial(link="logit"), data=sample)

 #Interactions
  condoms_inst_full_withint <- glm(condoms_inst ~ race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample)
  condoms_inst_noraceXreg <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  
  results_condoms_inst <- compare.models.noage(condoms_inst_full, condoms_inst_noregion, condoms_inst_norace, condoms_inst_full_withint, condoms_inst_noraceXreg)
  results_condoms_inst
  
```

The results of the regression analyses restricting the sample to men who had not used PrEP in the past 12 months are:
```{r condoms_inst_noprep}

##No PrEP in the past 12 months##
 #Main effects
  condoms_inst_full_noprep <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  condoms_inst_noregion_noprep <- glm(condoms_inst ~ race_eth_m.reg, family=binomial(link="logit"), data=sample_p12noprep)
  condoms_inst_norace_noprep <- glm(condoms_inst ~ region.bKC, family=binomial(link="logit"), data=sample_p12noprep)

 #Interactions
  condoms_inst_full_withint_noprep <- glm(condoms_inst ~ race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  condoms_inst_noraceXreg_noprep <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  
  results_condoms_inst_noprep <- compare.models.noage(condoms_inst_full_noprep, condoms_inst_noregion_noprep, condoms_inst_norace_noprep, condoms_inst_full_withint_noprep, condoms_inst_noraceXreg_noprep)
  results_condoms_inst_noprep
  
```

## Sex role
Sex role is categorized as exclusively bottom, exclusively top, or versatile, based on men's reported role in anal sex over the past 12 months. Responses of "mostly a bottom", "mostly a top", and "equally a bottom and a top" are categorized as versatile. For this analysis, dichotomous indicators was constructed to measure whether men report exclusively topping, exclusively bottoming, or a versatile sex role.
```{r}
  #Define indicators
  sample$position_top <- ifelse(sample$position_cat=="Exclusively top", 1, ifelse(!is.na(sample$position_cat), 0, NA))
  sample$position_bottom <- ifelse(sample$position_cat=="Exclusively bottom", 1, ifelse(!is.na(sample$position_cat), 0, NA))
  sample$position_versatile <- ifelse(sample$position_cat=="Versatile", 1, ifelse(!is.na(sample$position_cat), 0, NA))
  
  sample_p12noprep$position_top <- ifelse(sample_p12noprep$position_cat=="Exclusively top", 1, ifelse(!is.na(sample_p12noprep$position_cat), 0, NA))
  sample_p12noprep$position_bottom <- ifelse(sample_p12noprep$position_cat=="Exclusively bottom", 1, ifelse(!is.na(sample_p12noprep$position_cat), 0, NA))
  sample_p12noprep$position_versatile <- ifelse(sample_p12noprep$position_cat=="Versatile", 1, ifelse(!is.na(sample_p12noprep$position_cat), 0, NA))
  
```

### Exclusively topping
To inform parameterization of age in models exploring heterogeneity in the proportion of men who report exclusively topping, we will plot the ceofficients from a model with age input as a dummy variable with 5-year age bins, adjusting for race/ethnicity and region.
```{r}
#Figure out how to parameterize age
 #Full sample
    position_top_testage_all <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    agecoefs_position_top_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_top_testage_all$coefficients[2:8]), se = as.vector(coef(summary(position_top_testage_all))[2:8,2]))
    ageplot_position_top_all <- ggplot(agecoefs_position_top_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    position_top_testage_noprep <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
    agecoefs_position_top_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_top_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(position_top_testage_noprep))[2:8,2]))
    ageplot_position_top_noprep <- ggplot(agecoefs_position_top_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_position_top_all, ageplot_position_top_noprep, cols=1)

```

In both models, although the proportion of men reporting that they are exclusive tops seems to increase through age 44, it then fluctuates for older age groups. In subsequent models, we will represent age as a categorical variable with ages 40-59 binned in 10-year groups.

The results of the regression analyses using data from the full sample are:
```{r topping_full}

##Full sample##
 #Main effects
  top_full <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  top_noregion <- glm(position_top ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  top_norace <- glm(position_top ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample)
  top_noage <-  glm(position_top ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  
 #Interactions
  top_full_withint <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  top_noraceXreg <- glm(position_top ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  top_noraceXage <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  top_noageXreg <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  
  results_topping <- compare.models(top_full, top_noregion, top_norace, top_noage, top_full_withint, top_noraceXreg, top_noageXreg, top_noraceXage)
  results_topping
  
```

The results of the regression analyses restricting the sample to men who had not used PrEP in the past 12 months are:
```{r topping_noprep}

##No PrEP in the past 12 months##
 #Main effects
  top_full_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  top_noregion_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample_p12noprep)
  top_norace_noprep <- glm(position_top ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  top_noage_noprep <-  glm(position_top ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  
 #Interactions
  top_full_withint_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  top_noraceXreg_noprep <- glm(position_top ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  top_noraceXage_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  top_noageXreg_noprep <- glm(position_top ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  
  results_topping_noprep <- compare.models(top_full_noprep, top_noregion_noprep, top_norace_noprep, top_noage_noprep, top_full_withint_noprep, top_noraceXreg_noprep, top_noageXreg_noprep, top_noraceXage_noprep)
  results_topping_noprep
  
```

### Exclusively bottoming
As above, to inform parameterization of age in models exploring heterogeneity in the proportion of men who report exclusively bottoming, we will plot the ceofficients from a model with age input as a dummy variable with 5-year age bins, adjusting for race/ethnicity and region.
```{r}
#Figure out how to parameterize age
 #Full sample
    position_bottom_testage_all <- glm(position_bottom ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    agecoefs_position_bottom_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_bottom_testage_all$coefficients[2:8]), se = as.vector(coef(summary(position_bottom_testage_all))[2:8,2]))
    ageplot_position_bottom_all <- ggplot(agecoefs_position_bottom_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    position_bottom_testage_noprep <- glm(position_bottom ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
    agecoefs_position_bottom_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_bottom_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(position_bottom_testage_noprep))[2:8,2]))
    ageplot_position_bottom_noprep <- ggplot(agecoefs_position_bottom_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_position_bottom_all, ageplot_position_bottom_noprep, cols=1)

```

In the full sample and the subset excluding men who used PrEP in the past 12 months, the proportion of men reporting that they are exclusive bottoms seems to drop for men aged 35-39 and then increase again. To further explore this effect, in subsequent models, we will represent age as a categorical variable with ages 40-59 binned in 10-year groups.

The results of the regression analyses using data from the full sample are:
```{r bottoming_full}

##Full sample##
 #Main effects
  bottom_full <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  bottom_noregion <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  bottom_norace <- glm(position_bottom ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample)
  bottom_noage <-  glm(position_bottom ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  
 #Interactions
  bottom_full_withint <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  bottom_noraceXreg <- glm(position_bottom ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  bottom_noraceXage <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  bottom_noageXreg <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  
  results_bottoming <- compare.models(bottom_full, bottom_noregion, bottom_norace, bottom_noage, bottom_full_withint, bottom_noraceXreg, bottom_noageXreg, bottom_noraceXage)
  results_bottoming
  
```

The results of the regression analyses restricting the sample to men who had not used PrEP in the past 12 months are:
```{r bottoming_noprep}

##No PrEP in the past 12 months##
 #Main effects
  bottom_full_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noregion_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_norace_noprep <- glm(position_bottom ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noage_noprep <-  glm(position_bottom ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  
 #Interactions
  bottom_full_withint_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noraceXreg_noprep <- glm(position_bottom ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noraceXage_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  bottom_noageXreg_noprep <- glm(position_bottom ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  
  results_bottoming_noprep <- compare.models(bottom_full_noprep, bottom_noregion_noprep, bottom_norace_noprep, bottom_noage_noprep, bottom_full_withint_noprep, bottom_noraceXreg_noprep, bottom_noageXreg_noprep, bottom_noraceXage_noprep)
  results_bottoming_noprep
  
```

### Versatile
To inform parameterization of age in models exploring heterogeneity in the proportion of men who report being versatile in their anal sex role, we will plot the ceofficients from a model with age input as a dummy variable with 5-year age bins, adjusting for race/ethnicity and region.
```{r}
 #Figure out how to parameterize age
  #Full sample
    position_versatile_testage_all <- glm(position_versatile ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    agecoefs_position_versatile_all <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_versatile_testage_all$coefficients[2:8]), se = as.vector(coef(summary(position_versatile_testage_all))[2:8,2]))
    ageplot_position_versatile_all <- ggplot(agecoefs_position_versatile_all, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: full sample") + theme_title + plot_background

#Men who haven't used PrEP in the past 12 months
    position_versatile_testage_noprep <- glm(position_versatile ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
    agecoefs_position_versatile_noprep <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(position_versatile_testage_noprep$coefficients[2:8]), se = as.vector(coef(summary(position_versatile_testage_noprep))[2:8,2]))
    ageplot_position_versatile_noprep <- ggplot(agecoefs_position_versatile_noprep, aes(x=age_cat, y=coefs)) + geom_pointrange(aes(ymin=coefs - 1.96*se, ymax=coefs + 1.96*se)) + labs(x="Age groups", y="Adjusted coefficients and CI", title="Adjusted coefficients and 95% CI for age: No recent PrEP use") + theme_title + plot_background
    
    multiplot(ageplot_position_versatile_all, ageplot_position_versatile_noprep, cols=1)

```

These data do not suggest any clear trend by age. However, because sex role will be represented in the model using one 3-level variable for exclusively top, exclusively bottom, or versatile, we will include age in the models below as a categorical variable to be consistent with the approach taken for the indicators of exclusively topping and exclusively bottoming.

The results of the regression analyses using data from the full sample are:
```{r versatile_full}
 
##Full sample##
 #Main effects
  versatile_full <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  versatile_noregion <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  versatile_norace <- glm(position_versatile ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample)
  versatile_noage <-  glm(position_versatile ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  
 #Interactions
  versatile_full_withint <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  versatile_noraceXreg <- glm(position_versatile ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  versatile_noraceXage <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample)
  versatile_noageXreg <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  
  results_versatile <- compare.models(versatile_full, versatile_noregion, versatile_norace, versatile_noage, versatile_full_withint, versatile_noraceXreg, versatile_noageXreg, versatile_noraceXage)
  results_versatile
  
```

The results of the regression analyses restricting the sample to men who had not used PrEP in the past 12 months are:
```{r versatile_noprep}

##No PrEP in the past 12 months##
 #Main effects
  versatile_full_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noregion_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_norace_noprep <- glm(position_versatile ~ age_cat_alt +  region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noage_noprep <-  glm(position_versatile ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample_p12noprep)
  
 #Interactions
  versatile_full_withint_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noraceXreg_noprep <- glm(position_versatile ~ race_eth_m.reg + region.bKC + race_eth_m.reg*age_cat_alt + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noraceXage_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + region.bKC*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  versatile_noageXreg_noprep <- glm(position_versatile ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample_p12noprep)
  
  results_versatile_noprep <- compare.models(versatile_full_noprep, versatile_noregion_noprep, versatile_norace_noprep, versatile_noage_noprep, versatile_full_withint_noprep, versatile_noraceXreg_noprep, versatile_noageXreg_noprep, versatile_noraceXage_noprep)
  results_versatile_noprep
  
```
