# Regional variability {#explore_region}
```{r, include=FALSE}
####################################################################################
# Setup
####################################################################################
#-----------------------------------------------------------------------------------
# Load packages
#-----------------------------------------------------------------------------------

    library("tidyverse")
    library("knitr")
    library("data.table")
    library("lmtest")
    library("kableExtra")
    library("logbin")

#-----------------------------------------------------------------------------------
# Knitr options
#-----------------------------------------------------------------------------------
opts_chunk$set(echo=FALSE, message=FALSE, warning=TRUE, error=TRUE, fig.align = "center")
options(knitr.table.format = "html") 

#-----------------------------------------------------------------------------------
# Plot settings
#-----------------------------------------------------------------------------------
#save plot settings for white background and light grey lines and darkening the colors a bit
plot_background <- theme(panel.background = element_rect(fill="white", colour = "black")) + theme(panel.grid.major = element_line(colour = "grey90"))
darken_color <- scale_colour_hue(l=50)
theme_title <- theme(plot.title = element_text(hjust = 0.5, size=12)) 
        
#-----------------------------------------------------------------------------------
# Load data
#-----------------------------------------------------------------------------------

load(file="Data/InternetSurveySample.Rdata")
load(file="Data/InternetSurveySample_allages.Rdata")

#-----------------------------------------------------------------------------------
# Define alternate age categorization
#-----------------------------------------------------------------------------------
   sample$age_chunks <-  cut(sample$age, c(17, 29, 39, 44, 59), labels=c("18-29", "30-39", "40-49", "50-59"))   
    sample$age_cat_alt <- cut(sample$age, c(17, 24, 29, 34, 39, 49, 59), labels=c("18-24", "25-29", "30-34", "35-39", "40-49", "50-59"))

#----------------------------------------------------------------------------------
# Define multiplot function
#_---------------------------------------------------------------------------------
        multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
            library(grid)
            
            # Make a list from the ... arguments and plotlist
            plots <- c(list(...), plotlist)
            
            numPlots = length(plots)
            
            # If layout is NULL, then use 'cols' to determine layout
            if (is.null(layout)) {
                # Make the panel
                # ncol: Number of columns of plots
                # nrow: Number of rows needed, calculated from # of cols
                layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                                 ncol = cols, nrow = ceiling(numPlots/cols))
            }
            
            if (numPlots==1) {
                print(plots[[1]])
                
            } else {
                # Set up the page
                grid.newpage()
                pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
                
                # Make each plot, in the correct location
                for (i in 1:numPlots) {
                    # Get the i,j matrix positions of the regions that contain this subplot
                    matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
                    
                    print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                                    layout.pos.col = matchidx$col))
                }
            }
        }

#-----------------------------------------------------------------------------------
# Write function to streamline analyses
#-----------------------------------------------------------------------------------
#Function to plot the coefficients for age
plot.age.coefs <- function(full) {
    agecoefs <- cbind.data.frame(age_cat = c("25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59"), coefs = as.vector(full$coefficients[2:8]))
    plot <- ggplot(agecoefs, aes(x=age_cat, y=coefs)) + geom_point()
    return(plot)
}

#Function to get likelihood ratio tests
compare.models <- function(full, noreg, norace, noage, full_withint, noraceXreg, noageXreg, noraceXage) {
    lrt_region <- lrtest(full, noreg)
    lrt_race <- lrtest(full, norace)
    lrt_age <- lrtest(full, noage)
    lrt_summary_main <- cbind.data.frame("Variable" = c("Region", "Race", "Age"), "pvalue" = c(round(lrt_region$'Pr(>Chisq)'[2], 4), round(lrt_race$'Pr(>Chisq)'[2], 4), round(lrt_age$'Pr(>Chisq)'[2], 4)))
    lrt_summary_main$sig <- ifelse(lrt_summary_main$pvalue<0.001, "***", ifelse(lrt_summary_main$pvalue<0.01, "**", ifelse(lrt_summary_main$pvalue<0.05, "*", "")))
    
    lrt_raceXreg <- lrtest(full_withint, noraceXreg)
    lrt_ageXreg <- lrtest(full_withint, noageXreg)
    lrt_raceXage <- lrtest(full_withint, noraceXage)
    lrt_summary_int <- cbind.data.frame("Variable" = c("Race by region", "Age by region", "Race by age"), "pvalue" = c(round(lrt_raceXreg$'Pr(>Chisq)'[2], 4), round(lrt_ageXreg$'Pr(>Chisq)'[2], 4), round(lrt_raceXage$'Pr(>Chisq)'[2], 4)))
    lrt_summary_int$sig <-  ifelse(lrt_summary_int$pvalue<0.001, "***", ifelse(lrt_summary_int$pvalue<0.01, "**", ifelse(lrt_summary_int$pvalue<0.05, "*", "")))

    results <- list(summary(full), lrt_summary_main, summary(full_withint), lrt_summary_int)
    
    return(results)
}


```


This section documents the results of regression analyses aimed at identifying which variables vary by region, race, and/or age to determine the combination of attributes on which to stratify each parameter. P-values are to be used as a guide but not as the sole criteria determining which differences may be worth modeling. The purpose of this analysis is to determine how to specify parameters in order to get the network to reproduce the data. It is not an analysis to determine from the data which parameters differ significantly by region, race, or age in the population (since the sample is not probability-based, this would be difficult to conclude even if it were our goal). As such, corrections for multiple comparisons are not necessary, as these adjust the false discovery rate in analyses attempting to make inference about the population. We use likelihood ratio tests (package `lmtest`) to compare models for joint significance testing.

## Degree distribution

To look for differences in the degree distribution, we will break it down to two binary indicators corresponding to whether men have one or more ongoing partner of any type and whether they have any concurrent partners.

### One or more partners 
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
  #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$somepartners)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$somepartners)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$somepartners)])
```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    somepartners_full_testage <- glm(somepartners ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    plot.age.coefs(somepartners_full_testage)
```

From this it looks like age should be input as a categorical variable, but due to the small numbers in upper age groups, we will group ages 40-49 and 50-59.

The models and likelihood ratio tests are below.
```{r somepartners, eval=TRUE, error=TRUE}
 #Main effects
  somepartners_full <- glm(somepartners ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  somepartners_noregion <- glm(somepartners ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  somepartners_norace <- glm(somepartners ~ age_cat_alt + region.bKC, family=binomial(link="logit"), data=sample)
  somepartners_noage <- glm(somepartners ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)

 #Interactions
  somepartners_full_withint <- glm(somepartners ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  somepartners_noraceXreg <- glm(somepartners ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  somepartners_noageXreg <- glm(somepartners ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  somepartners_noraceXage <- glm(somepartners ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample)
  
  results_somepartners <- compare.models(somepartners_full, somepartners_noregion, somepartners_norace, somepartners_noage, somepartners_full_withint, somepartners_noraceXreg, somepartners_noageXreg, somepartners_noraceXage)
  results_somepartners
```


### Concurrency
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
    #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$concurrent)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$concurrent)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$concurrent)])
```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    concurrent_full_testage <- glm(concurrent ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    plot.age.coefs(concurrent_full_testage)
```

From this it looks like age should be input as a categorical variable, but due to the small numbers in upper age groups, we will group ages 40-49 and 50-59.

The models and likelihood ratio tests are below.
```{r concurrency, eval=TRUE, error=TRUE}
 #Main effects
  concurrent_full <- glm(concurrent ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  concurrent_noregion <- glm(concurrent ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  concurrent_norace <- glm(concurrent ~ age_cat_alt + region.bKC, family=binomial(link="logit"), data=sample)
  concurrent_noage <- glm(concurrent ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)

 #Interactions
  concurrent_full_withint <- glm(concurrent ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  concurrent_noraceXreg <- glm(concurrent ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  concurrent_noageXreg <- glm(concurrent ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample)
  concurrent_noraceXage <- glm(concurrent ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample)
  
  results_concurrent <- compare.models(concurrent_full, concurrent_noregion, concurrent_norace, concurrent_noage, concurrent_full_withint, concurrent_noraceXreg, concurrent_noageXreg, concurrent_noraceXage)
  results_concurrent
```


## Rate of instantaneous partners
__Note__: This analysis does not control for men's momentary degree.

We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
    #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$rate_inst)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$rate_inst)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$rate_inst)])
```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    rateinst_full_testage <- lm(rate_inst ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    plot.age.coefs(rateinst_full_testage)
```

From this it looks like age should be input as a categorical variable, but due to the small numbers in upper age groups, we will group ages 40-49 and 50-59.

The models and likelihood ratio tests are below.
```{r rateinst, eval=TRUE, error=TRUE}
 
 #Main effects
  rate_inst_full <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample)
  rate_inst_noregion <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg, data=sample)
  rate_inst_norace <- lm(rate_inst ~ age_cat_alt + region.bKC, data=sample)
  rate_inst_noage <- lm(rate_inst ~ race_eth_m.reg + region.bKC, data=sample)

 #Interactions
  rate_inst_full_withint <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  rate_inst_noraceXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  rate_inst_noageXreg <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  rate_inst_noraceXage <- lm(rate_inst ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_rate_inst <- compare.models(rate_inst_full, rate_inst_noregion, rate_inst_norace, rate_inst_noage, rate_inst_full_withint, rate_inst_noraceXreg, rate_inst_noageXreg, rate_inst_noraceXage)
    results_rate_inst
```


## Race/ethnicity mixing
To examine differences in mixing by race/ethnicity, we will look at the proportion of men reporting that their most recent partner was in the same racial/ethnic group (Hispanic, black, or other) as themselves. For main and persistent partner types, this analysis is restricted to most recent partners who are _ongoing_. __Note__: The outcome is based on ego reports of their partners race and, at this point, does not adjust for imbalances in reported partnering patterns.

```{r samerace_define}

  #Set to missing if the respondent did not know his partner's race/ethnicity
  sample$mrp_race_eth_m_removedk <- sample$mrp_race_eth_m[!(sample$mrp_race_eth_m %in% "Dont know")]
  sample$mrp_race_eth_m_removedk <- factor(sample$mrp_race_eth_m_removedk)
  
  #Define indicator of respondent and partner being of the same race/ethnicity
  sample$samerace <- ifelse(sample$race_eth_m==sample$mrp_race_eth_m_removedk, 1,
                                   ifelse(!is.na(sample$race_eth_m) & !is.na(sample$mrp_race_eth_m_removedk), 0,
                                          NA))
```

### Main partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
     #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_ongoing %in% "Main"], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_ongoing %in% "Main"], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_ongoing %in% "Main"])
```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    samerace_main_full_testage <- glm(samerace ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])
    plot.age.coefs(samerace_main_full_testage)
```

The coefficients appear more or less flat by age, with the exception of the huge spike for those aged 55-59. This is based on data from 16 men aged 55-59, all of whom reported a partner of the same race. Given this small number, we will model age as a categorical, combining ages 40-49 and 50-59.

The models and likelihood ratio tests are below.
```{r samerace_main, eval=TRUE}
 #Main effects
  samerace_main_full <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])
  samerace_main_noregion <- glm(samerace ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])
  samerace_main_norace <- glm(samerace ~ age_cat_alt + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])
  samerace_main_noage <- glm(samerace ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])

 #Interactions
  samerace_main_full_withint <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])
  samerace_main_noraceXreg <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])
  samerace_main_noageXreg <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])
  samerace_main_noraceXage <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Main", ])
  
  results_samerace_main <- compare.models(samerace_main_full, samerace_main_noregion, samerace_main_norace, samerace_main_noage, samerace_main_full_withint, samerace_main_noraceXreg, samerace_main_noageXreg, samerace_main_noraceXage)
  results_samerace_main

```


### Persistent partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
    
 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_ongoing %in% "Persistent"], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_ongoing %in% "Persistent"], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_ongoing %in% "Persistent"])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    samerace_pers_full_testage <- glm(samerace ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
    plot.age.coefs(samerace_pers_full_testage)
```

As with main partnerships, the coefficients appear more or less flat by age, with the exception of the huge spike for those aged 55-59. This is based on data from 16 men aged 55-59, all of whom reported a partner of the same race. Given this small number, we will model age as a categorical, combining ages 40-49 and 50-59.

The models and likelihood ratio tests are below.
```{r samerace_pers, eval=TRUE}
 
 #Main effects
  samerace_pers_full <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  samerace_pers_noregion <- glm(samerace ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  samerace_pers_norace <- glm(samerace ~ age_cat_alt + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  samerace_pers_noage <- glm(samerace ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])

 #Interactions
  samerace_pers_full_withint <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  samerace_pers_noraceXreg <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  samerace_pers_noageXreg <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  samerace_pers_noraceXage <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  
  results_samerace_pers <- compare.models(samerace_pers_full, samerace_pers_noregion, samerace_pers_norace, samerace_pers_noage, samerace_pers_full_withint, samerace_pers_noraceXreg, samerace_pers_noageXreg, samerace_pers_noraceXage)
  results_samerace_pers

```


### Instantaneous partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
  
 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_r %in% "One time"], sample$age_cat_alt[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_r %in% "One time"], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$samerace) & sample$mrp_type_r %in% "One time"])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    samerace_inst_full_testage <- glm(samerace ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])
    plot.age.coefs(samerace_inst_full_testage)
```

From this, we will model age as a categorical variable. Given the differences between the coefficients for ages 40-44 and 45-49 and for ages 50-54 and 55-59, we will not collapse these into 10-year groups.

The models and likelihood ratio tests are below.
```{r samerace_inst, eval=TRUE}

 #Main effects
  samerace_inst_full <- glm(samerace ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])
  samerace_inst_noregion <- glm(samerace ~ age_cat + race_eth_m.reg, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])
  samerace_inst_norace <- glm(samerace ~ age_cat + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])
  samerace_inst_noage <- glm(samerace ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])

 #Interactions
  samerace_inst_full_withint <- glm(samerace ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])
  samerace_inst_noraceXreg <- glm(samerace ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])
  samerace_inst_noageXreg <- glm(samerace ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])
  samerace_inst_noraceXage <- glm(samerace ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample[sample$mrp_type_r %in% "One time", ])
  
  results_samerace_inst <- compare.models(samerace_inst_full, samerace_inst_noregion, samerace_inst_norace, samerace_inst_noage, samerace_inst_full_withint, samerace_inst_noraceXreg, samerace_inst_noageXreg, samerace_inst_noraceXage)
  results_samerace_inst
```


## Age mixing
As with race/ethnicity, examination of age differences with main and persistent partners is restricted to most recent partners who are _ongoing_. For this analysis, we model age mixing using a linear model with the outcome being the absolute difference between the square root of the ego and alter's ages.

### Main partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    sqrtagediff_main_full_testage <- lm(sqrt_agediff ~ age_cat + race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_ongoing %in% "Main", ])
    plot.age.coefs(sqrtagediff_main_full_testage)
```

With the exception of the coefficients for ages 50-54 and 55-59, these appear close to linear. However, the coefficients for the models for persistent and instantaneous partnerships below do not appear linear. Although ages 50-54 and 55-59 appear quite different, there are only 19 and 17 respectively in each bin, so we will model age as a categorical variable, collapsing ages 40-59 into 10-year bins. 

The models and likelihood ratio tests are below.
```{r agemix_main, eval=TRUE}

 #Main effects
  sqrtagediff_main_full <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_ongoing %in% "Main", ])
  sqrtagediff_main_noregion <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg, data=sample[sample$mrp_type_ongoing %in% "Main", ])
  sqrtagediff_main_norace <- lm(sqrt_agediff ~ age_cat_alt + region.bKC, data=sample[sample$mrp_type_ongoing %in% "Main", ])
  sqrtagediff_main_noage <- lm(sqrt_agediff ~ race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_ongoing %in% "Main", ])

 #Interactions
  sqrtagediff_main_full_withint <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age*region.bKC + race_eth_m.reg*age, data=sample[sample$mrp_type_ongoing %in% "Main", ])
  sqrtagediff_main_noraceXreg <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + age*region.bKC + race_eth_m.reg*age, data=sample[sample$mrp_type_ongoing %in% "Main", ])
  sqrtagediff_main_noageXreg <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age, data=sample[sample$mrp_type_ongoing %in% "Main", ])
  sqrtagediff_main_noraceXage <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + age*region.bKC + race_eth_m.reg*region.bKC, data=sample[sample$mrp_type_ongoing %in% "Main", ])
  
  results_adiff_main <- compare.models(sqrtagediff_main_full, sqrtagediff_main_noregion, sqrtagediff_main_norace, sqrtagediff_main_noage, sqrtagediff_main_full_withint, sqrtagediff_main_noraceXreg, sqrtagediff_main_noageXreg, sqrtagediff_main_noraceXage)  
  results_adiff_main

```

### Persistent partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
#Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    sqrtagediff_pers_full_testage <- lm(sqrt_agediff ~ age_cat + race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
    plot.age.coefs(sqrtagediff_pers_full_testage)
```

Although the coefficients for ages 50-54 and 55-59 appear quite different, there are only 6 and 4 respectively in each bin, so we will model age as a categorical variable, collapsing ages 40-59 into 10-year bins. This is consistent with the approach taken for main partnerships.

The models and likelihood ratio tests are below.
```{r agemix_pers, eval=TRUE}

 #Main effects
  sqrtagediff_pers_full <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  sqrtagediff_pers_noregion <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  sqrtagediff_pers_norace <- lm(sqrt_agediff ~ age_cat_alt + region.bKC, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  sqrtagediff_pers_noage <- lm(sqrt_agediff ~ race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])

 #Interactions
  sqrtagediff_pers_full_withint <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  sqrtagediff_pers_noraceXreg <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  sqrtagediff_pers_noageXreg <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  sqrtagediff_pers_noraceXage <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample[sample$mrp_type_ongoing %in% "Persistent", ])
  
  results_adiff_pers <- compare.models(sqrtagediff_pers_full, sqrtagediff_pers_noregion, sqrtagediff_pers_norace, sqrtagediff_pers_noage, sqrtagediff_pers_full_withint, sqrtagediff_pers_noraceXreg, sqrtagediff_pers_noageXreg, sqrtagediff_pers_noraceXage)  
  results_adiff_pers
```

### Instantaneous partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
#Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$sqrt_agediff)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    sqrtagediff_inst_full_testage <- lm(sqrt_agediff ~ age_cat + race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_r %in% "One time", ])
    plot.age.coefs(sqrtagediff_inst_full_testage)
```

To be consistent with the approach for main and persistent partnerships, and becuase the estimate for 30-34 does not fit in a linear pattern, we will model age as a categorical variables with ages 40-59 in 10-year bins.

The models and likelihood ratio tests are below.
```{r agemix_inst, eval=TRUE}
 
 #Main effects
  sqrtagediff_inst_full <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_r %in% "One time", ])
  sqrtagediff_inst_noregion <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg, data=sample[sample$mrp_type_r %in% "One time", ])
  sqrtagediff_inst_norace <- lm(sqrt_agediff ~ age_cat_alt + region.bKC, data=sample[sample$mrp_type_r %in% "One time", ])
  sqrtagediff_inst_noage <- lm(sqrt_agediff ~ race_eth_m.reg + region.bKC, data=sample[sample$mrp_type_r %in% "One time", ])

 #Interactions
  sqrtagediff_inst_full_withint <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample[sample$mrp_type_r %in% "One time", ])
  sqrtagediff_inst_noraceXreg <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample[sample$mrp_type_r %in% "One time", ])
  sqrtagediff_inst_noageXreg <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample[sample$mrp_type_r %in% "One time", ])
  sqrtagediff_inst_noraceXage <- lm(sqrt_agediff ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample[sample$mrp_type_r %in% "One time", ])
  
  results_adiff_inst <- compare.models(sqrtagediff_inst_full, sqrtagediff_inst_noregion, sqrtagediff_inst_norace, sqrtagediff_inst_noage, sqrtagediff_inst_full_withint, sqrtagediff_inst_noraceXreg, sqrtagediff_inst_noageXreg, sqrtagediff_inst_noraceXage) 
  results_adiff_inst
```

## Partnership age
Partnership age was modeled as a linear outcome.

### Main partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$pship_age_main)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$pship_age_main)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$pship_age_main)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    pshipage_main_full_testage <- lm(pship_age_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    plot.age.coefs(pshipage_main_full_testage)
```

The coefficients appear to follow a mostly linear trend with age, however to be consistent with the approach taken for persistent partners (below), we will model age as a categorical variable with ages 40-59 grouped into 10-year bins.

The models and likelihood ratio tests are below.
```{r pshipage_main, eval=TRUE}

 #Main effects
  pshipage_main_full <- lm(pship_age_main ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample)
  pshipage_main_noregion <- lm(pship_age_main ~ age_cat_alt + race_eth_m.reg, data=sample)
  pshipage_main_norace <- lm(pship_age_main ~ age_cat_alt + region.bKC, data=sample)
  pshipage_main_noage <- lm(pship_age_main ~ race_eth_m.reg + region.bKC, data=sample)

 #Interactions
  pshipage_main_full_withint <- lm(pship_age_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  pshipage_main_noraceXreg <- lm(pship_age_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  pshipage_main_noageXreg <- lm(pship_age_main ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  pshipage_main_noraceXage <- lm(pship_age_main ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_pshipage_main <- compare.models(pshipage_main_full, pshipage_main_noregion, pshipage_main_norace, pshipage_main_noage, pshipage_main_full_withint, pshipage_main_noraceXreg, pshipage_main_noageXreg, pshipage_main_noraceXage)  
  results_pshipage_main

```

                
### Persistent partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
  #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$pship_age_pers)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$pship_age_pers)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$pship_age_pers)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    pshipage_pers_full_testage <- lm(pship_age_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    plot.age.coefs(pshipage_pers_full_testage)
```

The coefficients do not follow a linear pattern, so it is most appropriate to model age as a categorical variable. The coefficient for age group 45-49 is substantially higher than the others, but this appears to be driven by the presence of two outliers. As such, in light of the small numbers at older ages, we will group ages 40-59 into 10-year age groups.

The models and likelihood ratio tests are below.
```{r pshipage_pers, eval=TRUE}

 #Main effects
  pshipage_pers_full <- lm(pship_age_pers ~ age_cat_alt + race_eth_m.reg + region.bKC, data=sample)
  pshipage_pers_noregion <- lm(pship_age_pers ~ age_cat_alt + race_eth_m.reg, data=sample)
  pshipage_pers_norace <- lm(pship_age_pers ~ age_cat_alt + region.bKC, data=sample)
  pshipage_pers_noage <- lm(pship_age_pers ~ race_eth_m.reg + region.bKC, data=sample)

 #Interactions
  pshipage_pers_full_withint <- lm(pship_age_pers ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  pshipage_pers_noraceXreg <- lm(pship_age_pers ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  pshipage_pers_noageXreg <- lm(pship_age_pers ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, data=sample)
  pshipage_pers_noraceXage <- lm(pship_age_pers ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_pshipage_pers <- compare.models(pshipage_pers_full, pshipage_pers_noregion, pshipage_pers_norace, pshipage_pers_noage, pshipage_pers_full_withint, pshipage_pers_noraceXreg, pshipage_pers_noageXreg, pshipage_pers_noraceXage)  
  results_pshipage_pers
```

## Proportion never tested
The parameter indicating the proportion of men who never test is meant to indicate the proportion of men who will not be screened for HIV. In previous network models, this was defined as the proportion who never tested by age 40, since the model was capped at age 39. For this model, that may not be appropriate. For the current analysis, I simply modeled the probability that men had ever tested at their current age.

We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
   #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$evertest_r)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$evertest_r)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$evertest_r)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    evertest_full_testage <- glm(evertest_r ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    plot.age.coefs(evertest_full_testage)
```

The coefficients do not follow a linear pattern, so it is most appropriate to model age as a categorical variable. The number of respondents in older age groups seems sufficient to allow for categorizing age in 5-year bins.

The models and likelihood ratio tests are below.
```{r nevertest}
  
 #Main effects
  evertest_full <- glm(evertest_r ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  evertest_noregion <- glm(evertest_r ~ age_cat + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  evertest_norace <- glm(evertest_r ~ age_cat + region.bKC, family=binomial(link="logit"), data=sample)
  evertest_noage <- glm(evertest_r ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)

 #Interactions
  evertest_full_withint <- glm(evertest_r ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  evertest_noraceXreg <- glm(evertest_r ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  evertest_noageXreg <- glm(evertest_r ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  evertest_noraceXage <- glm(evertest_r ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample)
  
  results_evertest <- compare.models(evertest_full, evertest_noregion, evertest_norace, evertest_noage, evertest_full_withint, evertest_noraceXreg, evertest_noageXreg, evertest_noraceXage)
  results_evertest
 
```


## Intertest interval
The last test interval is estimated as the days since men reported their last HIV test, assuming men have a constant hazard of testing. This analysis is restricted to men who reported having ever tested.

We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
  #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$iti)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$iti)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$iti)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    iti_full_testage <- lm(iti ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    plot.age.coefs(iti_full_testage)
```

The coefficients do not follow a linear pattern, so it is most appropriate to model age as a categorical variable. As with the indicator for having ever tested, the number of respondents in older age groups seems sufficient to allow for categorizing age in 5-year bins, which is inidcated given the difference in coefficeints for ages 40-44 and 45-49 and for ages 50-54 and 55-59.

The models and likelihood ratio tests are below.
```{r iti, eval=TRUE}

 #Main effects
  iti_full <- lm(iti ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
  iti_noregion <- lm(iti ~ age_cat + race_eth_m.reg, data=sample)
  iti_norace <- lm(iti ~ age_cat + region.bKC, data=sample)
  iti_noage <- lm(iti ~ race_eth_m.reg + region.bKC, data=sample)

 #Interactions
  iti_full_withint <- lm(iti ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  iti_noraceXreg <- lm(iti ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  iti_noageXreg <- lm(iti ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, data=sample)
  iti_noraceXage <- lm(iti ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_iti <- compare.models(iti_full, iti_noregion, iti_norace, iti_noage, iti_full_withint, iti_noraceXreg, iti_noageXreg, iti_noraceXage)  
  results_iti
```

## Coital frequency
Data on coital frequency are from all most recent partnerships, not just those that are ongoing. 

### Main partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$airate_main)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$airate_main)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$airate_main)])
```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    airate_main_full_testage <- lm(airate_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    plot.age.coefs(airate_main_full_testage)
```

From these coefficients, it seems most appropriate to model age as a categorical variable. Although the numbers are small for older ages, it seems best to try to model age in 5-year groups to capture differences between 40-44 and 45-49 year-olds and between 50-54 and 55-59 year-olds.

The models and likelihood ratio tests are below.
```{r coitalfreq_main}
 #Main effects
  airate_main_full <- lm(airate_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
  airate_main_noregion <- lm(airate_main ~ age_cat + race_eth_m.reg, data=sample)
  airate_main_norace <- lm(airate_main ~ age_cat + region.bKC, data=sample)
  airate_main_noage <- lm(airate_main ~ race_eth_m.reg + region.bKC, data=sample)

 #Interactions
  airate_main_full_withint <- lm(airate_main ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  airate_main_noraceXreg <- lm(airate_main ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  airate_main_noageXreg <- lm(airate_main ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, data=sample)
  airate_main_noraceXage <- lm(airate_main ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_coitalfreq_main <- compare.models(airate_main_full, airate_main_noregion, airate_main_norace, airate_main_noage, airate_main_full_withint, airate_main_noraceXreg, airate_main_noageXreg, airate_main_noraceXage)
  results_coitalfreq_main
  
```


### Persistent partners
We first look at the number of observations that re non-missing for this outcome and for model predictors
```{r}
 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$airate_pers)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$airate_pers)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$airate_pers)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    airate_pers_full_testage <- lm(airate_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    plot.age.coefs(airate_pers_full_testage)
```

As above for coital frequency in main partnerships, it seems most appropriate to model age as a categorical variable. Although the numbers are small for older ages, it seems best to try to model age in 5-year groups to capture differences between 40-44 and 45-49 year-olds and between 50-54 and 55-59 year-olds.

The models and likelihood ratio tests are below.
```{r coitalfreq_pers}

 #Main effects
  airate_pers_full <- lm(airate_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
  airate_pers_noregion <- lm(airate_pers ~ age_cat + race_eth_m.reg, data=sample)
  airate_pers_norace <- lm(airate_pers ~ age_cat + region.bKC, data=sample)
  airate_pers_noage <- lm(airate_pers ~ race_eth_m.reg + region.bKC, data=sample)

 #Interactions
  airate_pers_full_withint <- lm(airate_pers ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  airate_pers_noraceXreg <- lm(airate_pers ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  airate_pers_noageXreg <- lm(airate_pers ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, data=sample)
  airate_pers_noraceXage <- lm(airate_pers ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_coitalfreq_pers <- compare.models(airate_pers_full, airate_pers_noregion, airate_pers_norace, airate_pers_noage, airate_pers_full_withint, airate_pers_noraceXreg, airate_pers_noageXreg, airate_pers_noraceXage)
  results_coitalfreq_pers
```

## Sex role
Sex role is categorized as exclusively bottom, exclusively top, or versatile, based on men's reported role in anal sex over the past 12 months. Responses of "mostly a bottom", "mostly a top", and "equally a bottom and a top" were categorized as versatile. For this analysis, a dichotomous indicator was constructed to measure whether men report any bottoming (bottoms and versatile men) or report exclusively topping.

We first look at the number of observations that are non-missing for this outcome and for model predictors
```{r}
 sample$position_top <- ifelse(sample$position_cat=="Exclusively top", 1, 
                                      ifelse(!is.na(sample$position_cat), 0, NA))
  sample$position_bottom <- ifelse(sample$position_cat=="Exclusively bottom", 1, 
                                      ifelse(!is.na(sample$position_cat), 0, NA))
  
  #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$position_top)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$position_top)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$position_top)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    top_full_testage <-  glm(position_top ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    plot.age.coefs(top_full_testage)
```

The plot of these coefficients suggests that age should be modeled as a categorical variable in 5-year age groups. 

The models and likelihood ratio tests are below.
```{r sexrole}
  
 #Main effects
  top_full <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  top_noregion <- glm(position_top ~ age_cat + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  top_norace <- glm(position_top ~ age_cat + region.bKC, family=binomial(link="logit"), data=sample)
  top_noage <- glm(position_top ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)

 #Interactions
  top_full_withint <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  top_noraceXreg <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  top_noageXreg <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  top_noraceXage <- glm(position_top ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample)
  
  results_sexrole <- compare.models(top_full, top_noregion, top_norace, top_noage, top_full_withint, top_noraceXreg, top_noageXreg, top_noraceXage)
  results_sexrole
  
```

## Condom use
Data on condom use are restricted to dyads in which both the respondent and his partner were HIV-negative or of unknown status. This analysis includes data from all such partnerships, not just those that were ongoing. 

### Main partners
We first look at the number of observations that are non-missing for this outcome and for model predictors
```{r}
 
 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$condoms_main)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$condoms_main)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$condoms_main)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    condoms_main_full_testage <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    plot.age.coefs(condoms_main_full_testage)
```

The plot of these coefficients suggests that age should be modeled as a categorical variable in 5-year age groups. 

The models and likelihood ratio tests are below.
```{r condoms_main}

 #Main effects
  condoms_main_full <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
  condoms_main_noregion <- lm(condoms_main ~ age_cat + race_eth_m.reg, data=sample)
  condoms_main_norace <- lm(condoms_main ~ age_cat + region.bKC, data=sample)
  condoms_main_noage <- lm(condoms_main ~ race_eth_m.reg + region.bKC, data=sample)

 #Interactions
  condoms_main_full_withint <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  condoms_main_noraceXreg <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  condoms_main_noageXreg <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, data=sample)
  condoms_main_noraceXage <- lm(condoms_main ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
 results_condoms_main <- compare.models(condoms_main_full, condoms_main_noregion, condoms_main_norace, condoms_main_noage, condoms_main_full_withint, condoms_main_noraceXreg, condoms_main_noageXreg, condoms_main_noraceXage)
  results_condoms_main
```


### Persistent partners
We first look at the number of observations that are non-missing for this outcome and for model predictors
```{r}
 
 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$condoms_pers)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$condoms_pers)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$condoms_pers)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    condoms_pers_full_testage <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
    plot.age.coefs(condoms_pers_full_testage)
```

The plot of these coefficients suggests that age should be modeled as a categorical variable in 5-year age groups, although the numbers are small for older ages. 

The models and likelihood ratio tests are below.
```{r condoms_pers}

 #Main effects
  condoms_pers_full <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC, data=sample)
  condoms_pers_noregion <- lm(condoms_pers ~ age_cat + race_eth_m.reg, data=sample)
  condoms_pers_norace <- lm(condoms_pers ~ age_cat + region.bKC, data=sample)
  condoms_pers_noage <- lm(condoms_pers ~ race_eth_m.reg + region.bKC, data=sample)

 #Interactions
  condoms_pers_full_withint <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  condoms_pers_noraceXreg <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, data=sample)
  condoms_pers_noageXreg <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, data=sample)
  condoms_pers_noraceXage <- lm(condoms_pers ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, data=sample)
  
  results_condoms_pers <- compare.models(condoms_pers_full, condoms_pers_noregion, condoms_pers_norace, condoms_pers_noage, condoms_pers_full_withint, condoms_pers_noraceXreg, condoms_pers_noageXreg, condoms_pers_noraceXage)
  results_condoms_pers
  
```

### Instantaneous partners
We first look at the number of observations that are non-missing for this outcome and for model predictors
```{r}

 #Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$condoms_inst)], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$condoms_inst)], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$condoms_inst)])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    condoms_inst_full_testage <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
    plot.age.coefs(condoms_inst_full_testage)
```

The plot of these coefficients suggests that age should be modeled as a categorical variable in 5-year age groups, although the numbers are small for older ages. 

The models and likelihood ratio tests are below.
```{r condoms_inst}

 #Main effects
  condoms_inst_full <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)
  condoms_inst_noregion <- glm(condoms_inst ~ age_cat + race_eth_m.reg, family=binomial(link="logit"), data=sample)
  condoms_inst_norace <- glm(condoms_inst ~ age_cat + region.bKC, family=binomial(link="logit"), data=sample)
  condoms_inst_noage <- glm(condoms_inst ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample)

 #Interactions
  condoms_inst_full_withint <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  condoms_inst_noraceXreg <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  condoms_inst_noageXreg <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat, family=binomial(link="logit"), data=sample)
  condoms_inst_noraceXage <- glm(condoms_inst ~ age_cat + race_eth_m.reg + region.bKC + age_cat*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample)
  
  results_condoms_inst <- compare.models(condoms_inst_full, condoms_inst_noregion, condoms_inst_norace, condoms_inst_noage, condoms_inst_full_withint, condoms_inst_noraceXreg, condoms_inst_noageXreg, condoms_inst_noraceXage)
  results_condoms_inst
  
```


## PrEP use
To look at differences in PrEP use, the outcome is reported current use of PrEP _among those for whom PrEP is recommended_.

We first look at the number of observations that are non-missing for this outcome and for model predictors
```{r}
 
#Look at the number of observations that are non-missing for this outcome and for model predictors
  table(sample$hbo[!is.na(sample$race_eth_m) & !is.na(sample$prep_use_curr) & sample$prepelig_r %in% "Recommend"], sample$age_cat[!is.na(sample$race_eth_m) & !is.na(sample$prep_use_curr) & sample$prepelig_r %in% "Recommend"], sample$region[!is.na(sample$race_eth_m) & !is.na(sample$prep_use_curr) & sample$prepelig_r %in% "Recommend"])

```

Next we will look at how to parameterize age by plotting the ceofficients from the full model with age input as a dummy variable with 5-year age bins
```{r}
 #Figure out how to parameterize age
    prep_full_testage <- glm(prep_use_curr ~ age_cat + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")
    plot.age.coefs(prep_full_testage)
```

The plot of these coefficients suggests that age should be modeled as a categorical variable. We will group ages 40-59 in 10-year age groups.

The models and likelihood ratio tests are below.
```{r prep}

 #Main effects
  prep_full <- glm(prep_use_curr ~ age_cat_alt + race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")
  prep_noregion <- glm(prep_use_curr ~ age_cat_alt + race_eth_m.reg, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")
  prep_norace <- glm(prep_use_curr ~ age_cat_alt + region.bKC, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")
  prep_noage <- glm(prep_use_curr ~ race_eth_m.reg + region.bKC, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")

 #Interactions
  prep_full_withint <- glm(prep_use_curr ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")
  prep_noraceXreg <- glm(prep_use_curr ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")
  prep_noageXreg <- glm(prep_use_curr ~ age_cat_alt + race_eth_m.reg + region.bKC + race_eth_m.reg*region.bKC + race_eth_m.reg*age_cat_alt, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")
  prep_noraceXage <- glm(prep_use_curr ~ age_cat_alt + race_eth_m.reg + region.bKC + age_cat_alt*region.bKC + race_eth_m.reg*region.bKC, family=binomial(link="logit"), data=sample, subset=prepelig_r %in% "Recommend")
  
  results_prep <- compare.models(prep_full, prep_noregion, prep_norace, prep_noage, prep_full_withint, prep_noraceXreg, prep_noageXreg, prep_noraceXage)
  results_prep

```


## Summary tables

```{r summaries}

    summary_network <- cbind.data.frame("Parameter" = c("One or more partners", "Any concurrent partners", "Rate of instantaneous partners", "Main partnerships", "Persistent partnerships", "Instantaneous partnerships", "Main partnerships", "Persistent partnerships", "Instantaneous partnerships", "Main partnerships", "Persistent partnerships"), "Region" = c(results_somepartners[[2]][1,3], results_concurrent[[2]][1,3], results_rate_inst[[2]][1,3], results_samerace_main[[2]][1,3], results_samerace_pers[[2]][1,3], results_samerace_inst[[2]][1,3], results_adiff_main[[2]][1,3], results_adiff_pers[[2]][1,3], results_adiff_inst[[2]][1,3], results_pshipage_main[[2]][1,3], results_pshipage_pers[[2]][1,3]), "Race" = c(results_somepartners[[2]][2,3], results_concurrent[[2]][2,3], results_rate_inst[[2]][2,3], results_samerace_main[[2]][2,3], results_samerace_pers[[2]][2,3], results_samerace_inst[[2]][2,3], results_adiff_main[[2]][2,3], results_adiff_pers[[2]][2,3], results_adiff_inst[[2]][2,3], results_pshipage_main[[2]][2,3], results_pshipage_pers[[2]][2,3]), "Age" = c(results_somepartners[[2]][3,3], results_concurrent[[2]][3,3], results_rate_inst[[2]][3,3], results_samerace_main[[2]][3,3], results_samerace_pers[[2]][3,3], results_samerace_inst[[2]][3,3], results_adiff_main[[2]][3,3], results_adiff_pers[[2]][3,3], results_adiff_inst[[2]][3,3], results_pshipage_main[[2]][3,3], results_pshipage_pers[[2]][3,3]), "Race_by_region" = c(results_somepartners[[4]][1,3], results_concurrent[[4]][1,3], results_rate_inst[[4]][1,3], results_samerace_main[[4]][1,3], results_samerace_pers[[4]][1,3], results_samerace_inst[[4]][1,3], results_adiff_main[[4]][1,3], results_adiff_pers[[4]][1,3], results_adiff_inst[[4]][1,3], results_pshipage_main[[4]][1,3], results_pshipage_pers[[4]][1,3]), "Age_by_region" = c(results_somepartners[[4]][2,3], results_concurrent[[4]][2,3], results_rate_inst[[4]][2,3], results_samerace_main[[4]][2,3], results_samerace_pers[[4]][2,3], results_samerace_inst[[4]][2,3], results_adiff_main[[4]][2,3], results_adiff_pers[[4]][2,3], results_adiff_inst[[4]][2,3], results_pshipage_main[[4]][2,3], results_pshipage_pers[[4]][2,3]), "Race_by_age" = c(results_somepartners[[4]][3,3], results_concurrent[[4]][3,3], results_rate_inst[[4]][3,3], results_samerace_main[[4]][3,3], results_samerace_pers[[4]][3,3], results_samerace_inst[[4]][3,3], results_adiff_main[[4]][3,3], results_adiff_pers[[4]][3,3], results_adiff_inst[[4]][3,3], results_pshipage_main[[4]][3,3], results_pshipage_pers[[4]][3,3]))

    kable(summary_network, col.names=c("Parameter", "Region", "Race", "Age", "Race by region", "Age by region", "Race by age"), caption="Summary of regression model findings for associations with network model parameters") %>% kable_styling(full_width=F, position="center") %>% group_rows("Degree distribution", 1, 2) %>% group_rows("Proportion of partnerships same race", 4, 6) %>% group_rows("Age mixing (sqrt of age difference", 7, 9) %>% group_rows("Partnership age", 10, 11) %>% add_header_above(c(" " = 1, "Main effects" = 3, "Interactions" = 3)) %>% add_footnote(c("*p-value<0.05", "**p-value<0.01", "***p-value<0.001"), notation="number") %>% row_spec(3, bold=TRUE)
    
    summary_epidemic <- cbind.data.frame("Parameter" = c("Proportion ever tested", "Intertest interval", "Main partnerships", "Persistent partnerships", "Anal sex as top only", "Main partnerships", "Persistent partnerships", "Instantaneous partnerships", "PrEP use among those recommended"), "Region" = c(results_evertest[[2]][1,3], results_iti[[2]][1,3], results_coitalfreq_main[[2]][1,3], results_coitalfreq_pers[[2]][1,3], results_sexrole[[2]][1,3], results_condoms_main[[2]][1,3], results_condoms_pers[[2]][1,3], results_condoms_inst[[2]][1,3], results_prep[[2]][1,3]), "Race" = c(results_evertest[[2]][2,3], results_iti[[2]][2,3], results_coitalfreq_main[[2]][2,3], results_coitalfreq_pers[[2]][2,3], results_sexrole[[2]][2,3], results_condoms_main[[2]][2,3], results_condoms_pers[[2]][2,3], results_condoms_inst[[2]][2,3], results_prep[[2]][2,3]), "Age" = c(results_evertest[[2]][3,3], results_iti[[2]][3,3], results_coitalfreq_main[[2]][3,3], results_coitalfreq_pers[[2]][3,3], results_sexrole[[2]][3,3], results_condoms_main[[2]][3,3], results_condoms_pers[[2]][3,3], results_condoms_inst[[2]][3,3], results_prep[[2]][3,3]), "Race_by_region" = c(results_evertest[[4]][1,3], results_iti[[4]][1,3], results_coitalfreq_main[[4]][1,3], results_coitalfreq_pers[[4]][1,3], results_sexrole[[4]][1,3], results_condoms_main[[4]][1,3], results_condoms_pers[[4]][1,3], results_condoms_inst[[4]][1,3], results_prep[[4]][1,3]), "Age_by_region" = c(results_evertest[[4]][2,3], results_iti[[4]][2,3], results_coitalfreq_main[[4]][2,3], results_coitalfreq_pers[[4]][2,3], results_sexrole[[4]][2,3], results_condoms_main[[4]][2,3], results_condoms_pers[[4]][2,3], results_condoms_inst[[4]][2,3], results_prep[[4]][2,3]), "Race_by_age" = c(results_evertest[[4]][3,3], results_iti[[4]][3,3], results_coitalfreq_main[[4]][3,3], results_coitalfreq_pers[[4]][3,3], results_sexrole[[4]][3,3], results_condoms_main[[4]][3,3], results_condoms_pers[[4]][3,3], results_condoms_inst[[4]][3,3], results_prep[[4]][3,3]))

    kable(summary_epidemic, col.names=c("Parameter", "Region", "Race", "Age", "Race by region", "Age by region", "Race by age"), caption="Summary of regression model findings for associations with epidemic model parameters") %>% kable_styling(full_width=F, position="center") %>% group_rows("Coital frequency", 3, 4) %>% group_rows("Condom use", 6, 8) %>% add_header_above(c(" " = 1, "Main effects" = 3, "Interactions" = 3)) %>% add_footnote(c("*p-value<0.05", "**p-value<0.01", "***p-value<0.001"), notation="number") %>% row_spec(c(1,2,5,9), bold=TRUE)
    
    ```

These analyses were intended as a guide to suggest which nodal attributes appear to shape patterns of partnership formation/persistence and behaviors related to transmission and diagnosis. For network model parameters, there appear to be **racial/ethnic differences in race and age mixing** and **age differences in the <span style="color:red">degree distribution</span>, rate of instantaneous partnerships, race mixing, age mixing, and dissolution (partnership age)**. While there are some significant interactions, they do not suggest a clear pattern, so we will focus on the main effects. For epidemic model parameters, we will explore **age effects on HIV testing behavior and condom use**, and **the effects of all three nodal attributes on PrEP use**.

## Plots {#plots}
The plots below further explore the associations highlighted in the above section.

### Race mixing by race and age 

We would expect the proportion of partnerships that are same race to vary by race merely by chance due to the composition of the population, so the fact that this varies by race is not surprising. The first plot (\@ref(fig:plotsexplore_racemixing_1)) below shows the same race partnerships in blue and additionally examines the distribution of off-diagonal partnerships. Dyad race/ethnicity is listed along the x-axis as reported by the respondent, such that partnerships reported by black men with Hispanics are listed separately from partnerships reported by Hispanic men with blacks. The numbers are small for most of the dyad race categories, making this hard to interpret. The second plot (\@ref(fig:plotsexplore_racemixing_2)) looks at race mixing by age group. Plot \@ref(fig:plotsexplore_racemixing_3) shows race mixing by ego race and age group.
```{r plots_explore_racemixing_1}

#Race mixing by race
    # #Look at race mixing distribution expected by chance based on population distribution if everyone had equal contact rates
    #     total.hbo <- (pop.raceregion %>% group_by(hbo) %>% summarise(Freq=sum(Freq)))
    #     racemixing_expected_num <- c("H-H" = ((total.hbo$Freq[total.hbo$hbo %in% "Hispanic"]*total.hbo$Freq[total.hbo$hbo %in% "Hispanic"])/sum(total.hbo$Freq)), "H-B" = ((total.hbo$Freq[total.hbo$hbo %in% "Hispanic"]*total.hbo$Freq[total.hbo$hbo %in% "Black"])/sum(total.hbo$Freq)), "H-O" = ((total.hbo$Freq[total.hbo$hbo %in% "Hispanic"]*total.hbo$Freq[total.hbo$hbo %in% "Other"])/sum(total.hbo$Freq)), "B-H" = ((total.hbo$Freq[total.hbo$hbo %in% "Black"]*total.hbo$Freq[total.hbo$hbo %in% "Hispanic"])/sum(total.hbo$Freq)), "B-B" = ((total.hbo$Freq[total.hbo$hbo %in% "Black"]*total.hbo$Freq[total.hbo$hbo %in% "Black"])/sum(total.hbo$Freq)), "B-O" = ((total.hbo$Freq[total.hbo$hbo %in% "Black"]*total.hbo$Freq[total.hbo$hbo %in% "Other"])/sum(total.hbo$Freq)), "O-H" = ((total.hbo$Freq[total.hbo$hbo %in% "Other"]*total.hbo$Freq[total.hbo$hbo %in% "Hispanic"])/sum(total.hbo$Freq)), "O-B" = ((total.hbo$Freq[total.hbo$hbo %in% "Other"]*total.hbo$Freq[total.hbo$hbo %in% "Black"])/sum(total.hbo$Freq)), "O-O" = ((total.hbo$Freq[total.hbo$hbo %in% "Other"]*total.hbo$Freq[total.hbo$hbo %in% "Other"])/sum(total.hbo$Freq)))
    #     racemixing_expected_rowprob <- c(racemixing_expected_num[1]/sum(racemixing_expected_num[1:3]), racemixing_expected_num[2]/sum(racemixing_expected_num[1:3]), racemixing_expected_num[3]/sum(racemixing_expected_num[1:3]), racemixing_expected_num[4]/sum(racemixing_expected_num[4:6]), racemixing_expected_num[5]/sum(racemixing_expected_num[4:6]), racemixing_expected_num[6]/sum(racemixing_expected_num[4:6]), racemixing_expected_num[7]/sum(racemixing_expected_num[7:9]), racemixing_expected_num[8]/sum(racemixing_expected_num[7:9]), racemixing_expected_num[9]/sum(racemixing_expected_num[7:9]))
    #     racemixing_expected <- cbind.data.frame("hbo" = c("H-H", "H-B", "H-O", "B-H", "B-B", "B-O", "O-H", "O-B", "O-O"), "prob" = racemixing_expected_rowprob)

    racemixingXrace <- sample %>% filter(!is.na(mrp_race_eth_m) & !is.na(mrp_type_ongoing)) %>% group_by(mrp_type_ongoing, race_eth_m, mrp_race_eth_m) %>% summarise(Freq=n()) %>% mutate(Percent = Freq/sum(Freq))
    racemixingXrace$dyadrace <- (c("H-H", "H-B", "H-O", "B-H", "B-B", "B-O", "O-H", "O-B", "O-O", "H-H", "H-B", "H-O", "B-O", "O-H", "O-B", "O-O"))
    racemixingXrace$samerace <- c("Yes", "No", "No", "No", "Yes", "No", "No", "No", "Yes", "Yes", "No", "No", "No", "No", "No", "Yes")
    racemixingXrace$dyadrace <- factor(racemixingXrace$dyadrace, levels = c("H-H", "H-B", "H-O", "B-H", "B-B", "B-O", "O-H", "O-B", "O-O"))
    
    ggplot(racemixingXrace) + geom_point(aes(x=dyadrace, y=Percent, colour=samerace, size=Freq), shape=16) + facet_grid(mrp_type_ongoing ~.) + plot_background + labs(x="Dyad race/ethnicity (ego-alter)", y="Percent", title="Race mixing as reported by ego") + theme_title + ylim(0, 1)

```

```{r plots_explore_racemixing_2}
#Race mixing by age
    racemixingXage <- sample %>% filter(!is.na(mrp_race_eth_m) & !is.na(mrp_type_ongoing)) %>% mutate(samerace = ifelse(race_eth_m==mrp_race_eth_m, 1, 0)) %>% group_by(mrp_type_ongoing, age_chunks) %>% summarise(freq = n(), percent_samerace = mean(samerace))
    
    ggplot(racemixingXage) + geom_point(aes(x=age_chunks, y=percent_samerace, size=freq), shape=16) + facet_grid(mrp_type_ongoing ~.) + plot_background + labs(x="Age group", y="Percent", title="Racial/ethnic homophily by age as reported by ego") + theme_title + ylim(0, 1)
```

```{r plots_explore_racemixing_3}
#Race mixing by age and ego race
    racemixingXageandrace <- sample %>% filter(!is.na(mrp_race_eth_m) & !is.na(mrp_type_ongoing)) %>% group_by(mrp_type_ongoing, age_chunks, race_eth_m, mrp_race_eth_m) %>% summarise(Freq=n()) %>% mutate(Percent = Freq/sum(Freq))
    racemixingXageandrace$samerace <- factor(ifelse(racemixingXageandrace$race_eth_m==racemixingXageandrace$mrp_race_eth_m, "Yes", "No"))
    racemixingXageandrace <-  racemixingXageandrace %>% filter(samerace %in% "Yes")
    
    ggplot(racemixingXageandrace) + geom_point(aes(x=age_chunks, y=Percent, size=Freq, colour=race_eth_m), shape=16) + facet_grid(mrp_type_ongoing ~.) + plot_background + labs(x="Age group", y="Percent", title="Racial/ethnic homophily by age **and ego race** as reported by ego") + theme_title + ylim(0, 1)

```

__Decision__: While it does appear that 40-49 year-olds are slightly more likely to report a partner of the same racial/ethnic group, the data do not suggest a clear or meaningful pattern of race mixing by age. As such, we will not stratify race mixing by age.


### Age mixing by age and race

The left panel of figure \@ref(fig:plots_explore_agemixing_1) shows a scatter plot of respondents ages against the ages reported for their partners in single years. In partnerships below the diagonal line, the ego is older than his partner; in partnerships above the line, the partner is older than the ego. The right panel plots the absolute value of the difference between ego and alter ages, with a superimposed loess smooth curve. Plot \@ref(fig:plots_explore_agemixing_2) shows age mixing by age group and race in terms of the mean absolute difference in age between the ego and his partner in each age group. To inform how to parameterize age differences, plot \@ref(fig:plots_explore_agemixing_3) shows the absolute difference between the square root of ego and alter ages by ego ego, and plot \@ref(fig:plots_explore_agemixing_4) shows the absolute difference between the cube root of ego and alter ages by ego ego.

```{r plots_explore_agemixing_1}

#Age mixing
    sample$agediff <- abs(sample$age - sample$mrp_ageinyears_approx)

    age_scatter <- ggplot(sample[!is.na(sample$mrp_ageinyears_approx) & !is.na(sample$mrp_type_ongoing),]) + geom_point(aes(x=age, y=mrp_ageinyears_approx)) + geom_abline(slope=1, intercept= 0) + facet_grid(mrp_type_ongoing ~.) + labs(x="Ego age", y="Most recent partner age", title="Age differences by single year age")
    
    age_diff <- ggplot(sample[!is.na(sample$agediff) & !is.na(sample$mrp_type_ongoing),], aes(x=age, y=agediff)) + geom_point() + geom_smooth(method="loess") + facet_grid(mrp_type_ongoing ~.) + labs(x="Ego age", y="Absolute value of the difference between ego and alter ages", title = "Age mixing as the difference between ego and alter ages") + theme_title
    
    multiplot(age_scatter, age_diff, cols=2)
    
```

```{r plots_explore_agemixing_2}

#Age mixing by age and race 

    agemixingXrace <- sample %>% filter(!is.na(agediff) & !is.na(mrp_type_ongoing)) %>% group_by(mrp_type_ongoing, age_cat, race_eth_m) %>% summarise(freq= n(), mean = mean(agediff))
    ggplot(agemixingXrace) + geom_point(aes(x=age_cat, y=mean, size=freq, colour=race_eth_m)) + facet_grid(mrp_type_ongoing ~.) + geom_hline(yintercept=0) + labs(x="Ego age group", y="Mean difference between ego and partner age (absolute value)", title="Age differences by race and age category") + theme_title

```

```{r plots_explore_agemixing_3}

#Age mixing represented as square root of age differences
    ggplot(sample[!is.na(sample$sqrt_agediff) & !is.na(sample$mrp_type_ongoing),], aes(x=age, y=sqrt_agediff)) + geom_point() + geom_smooth(method="loess") + facet_grid(mrp_type_ongoing ~.) + labs(x="Ego age", y="Absolute value of the difference between the sqrt of ego and the sqrt of alter ages", title = "Age mixing as the difference between the square root of ego and alter ages") + theme_title

```

```{r plots_explore_agemixing_4}
    sample$cbrt_agediff <- abs(sample$age^(1/3) - sample$mrp_ageinyears_approx^(1/3))

    ggplot(sample[!is.na(sample$cbrt_agediff) & !is.na(sample$mrp_type_ongoing),], aes(x=age, y=cbrt_agediff)) + geom_point() + geom_smooth(method="loess") + facet_grid(mrp_type_ongoing ~.) + labs(x="Ego age", y="Absolute value of the difference between the cube root of ego and the cube root of alter ages", title = "Age mixing as the difference between the cube root of ego and alter ages") + theme_title
   
```

__Decision__: The patterns for non-Hispanic other and Hispanic respondents appear similar. Black men ages 18-24 report partners who are, on average, further in age from themselves than the other racial/ethnic groups. But the numbers are small: `r sum(!is.na(sample$mrp_ageinyears_approx) & sample$race_eth_m %in% "Black" & sample$mrp_type_ongoing %in% "Main" & sample$age_cat %in% "18-24")` black respondents provided data on the age of main partners and only `r sum(!is.na(sample$mrp_ageinyears_approx) & sample$race_eth_m %in% "Black" & sample$mrp_type_ongoing %in% "Persistent" & sample$age_cat %in% "18-24")` provided data on the age of persistent partners. As such, these patterns should be interpreted with caution. To capture potential racial ethnic differences, we will represent heterogeneity in age mixing by race, but we will not attempt to represent an interaction between race and age on patterns of age mixing.

To capture the age heterogeneity in age mixing, we need to decide how to parameterize the age difference. From plots \@ref(fig:plots_explore_agemixing_3) and \@ref(fig:plots_explore_agemixing_4), taking the difference between the square root of ego and alter ages reduces the heterogeneity by age, but does not fully account for differences by ego age in the age difference with persistent partnerships. Taking the cube root does not lead to a noticeable improvement.

### Degree distribution by age

```{r plots_explore_somepartners_1}
#One or more ongoing partners by age
    somepartnersXage <- sample %>% filter(!is.na(somepartners)) %>% group_by(age_cat) %>% summarise(prop = mean(somepartners, na.rm=TRUE), freq=n())
    
    ggplot(somepartnersXage) + geom_point(aes(x=age_cat, y=prop, size=freq), shape=16) + plot_background + labs(x="Age", y="Percent", title="Proportion reporting one or more ongoing partners by age") + theme_title + ylim(0, 1)

```

```{r plots_explore_concurrent_1}
#One or more ongoing partners by age
    concurrentXage <- sample %>% filter(!is.na(concurrent)) %>% group_by(age_cat) %>% summarise(prop = mean(concurrent, na.rm=TRUE), freq=n())
    
    ggplot(concurrentXage) + geom_point(aes(x=age_cat, y=prop, size=freq), shape=16) + plot_background + labs(x="Age", y="Percent", title="Proportion reporting two or more concurrent partners by age") + theme_title + ylim(0, 1)

```
__Decision__: <span style="color:red"> Fill me in </span>

### Rate of instantaneous partnerships by age

The left panel of figure \@ref(fig:plots_explore_rate_inst_1) shows the reported rate of instantaneous partnerships by respondent age in single years with a superimposed loess smooth curve. From this we see that there are some outliers - 4 respondents who reported >0.25 instantaneous partnerships per day. The right panel shows the same plot but with these 4 outliers removed. Figure \@ref(fig:plots_explore_rate_inst_2) groups ages into smaller bins for those aged 18-34 to get insight as to where the inflection point might be. The high point for ages 35-39 is largely driven by the outliers - removal of these outliers drops the point down in line with the others. 

```{r plots_explore_rateinst_1}
#Rate of instantaneous partnerships by age
    p_rateinstXage <- ggplot(sample[!is.na(sample$rate_inst),], aes(x=age, y=rate_inst)) + geom_point() + geom_smooth(method="loess") + labs(x="Ego age", y="Rate of instantaneous partnerships", title="Rate of instantaneous partnerships by ego age")
    p_rateinstXage_rmoutliers <- ggplot(sample[!is.na(sample$rate_inst) & sample$rate_inst <0.25,], aes(x=age, y=rate_inst)) + geom_point() + geom_smooth(method="loess") + labs(x="Ego age", y="Rate of instantaneous partnerships", title="Rate of instantaneous partnerships by ego age without outliers")
    multiplot(p_rateinstXage, p_rateinstXage_rmoutliers, cols=2)

```

```{r plots_explore_rateinst_2}
    sample$age_cat_explore <- cut(sample$age, c(17, 20, 22, 24, 26, 28, 30, 32, 34, 39, 44, 49, 54, 59), labels=c("18-20", "21-22", "23-24", "25-26", "27-28", "29-30", "31-32", "33-34", "35-39", "40-44", "45-49", "50-54", "55-59"))     
    rateinstXage <- sample %>% filter(!is.na(rate_inst)) %>% group_by(age_cat_explore) %>% summarise(mean = mean(rate_inst), median=median(rate_inst), freq = n()) 
    ggplot(rateinstXage) + geom_point(aes(x=age_cat_explore, y=mean, size=freq)) + labs(x="Ego age", y="Mean rate of instantaneous partnerships", title="Mean rate of instantaneous partnerships by ego age group")

```

To explore this further, we look at the proportion of men in each age group that fall in each of the quartiles of the distribution of instantaneous partnerships identified in section \@ref(rateinst_explore).
```{r plots_explore_rateinst_3}

    quartiles <- quantile(sample$rate_inst, c(0.025, 0.5, 0.75, 1), na.rm=TRUE)
sample$rate_inst_quart <- cut(sample$rate_inst, c(-0.01, quartiles), labels=c("0", "(0, 0.00274]", "(0.00274, 0.00821]", "(0.00821, 0.931]"))
table(sample$rate_inst_quart)

    ageXquartile_explore <- sample %>% filter(!is.na(rate_inst)) %>% group_by(age_cat_explore) %>% summarise(freq=n(), zero = sum(rate_inst_quart %in% "0")/freq, low = sum(rate_inst_quart %in% "(0, 0.00274]")/freq, med = sum(rate_inst_quart %in% "(0.00274, 0.00821]")/freq, high = sum(rate_inst_quart %in% "(0.00821, 0.931]")/freq)
    ggplot(ageXquartile) + geom_point(aes(x=age_cat_explore, y=zero, colour="a"), size=3) +  geom_point(aes(x=age_cat_explore, y=low, color="b"), size=3) + geom_point(aes(x=age_cat_explore, y=med, color="c"), size=3) + geom_point(aes(x=age_cat_explore, y=high, colour="d"), size=3) + scale_colour_manual(name = "Rate of partners", values=c("a"="red", "b"="orange", "c"="yellow", "d"="darkgreen"), labels=c("Zero", "Low", "Medium", "High")) + labs(x="Age group", y="Percent", title="Quantile distribution of the rate of instantaneous partners by detailed age groups") + theme_title + plot_background 
    

    ageXquartile <- sample %>% filter(!is.na(rate_inst)) %>% group_by(age_cat) %>% summarise(freq=n(), zero = sum(rate_inst_quart %in% "0")/freq, low = sum(rate_inst_quart %in% "(0, 0.00274]")/freq, med = sum(rate_inst_quart %in% "(0.00274, 0.00821]")/freq, high = sum(rate_inst_quart %in% "(0.00821, 0.931]")/freq)
    ggplot(ageXquartile) + geom_point(aes(x=age_cat, y=zero, colour="a"), size=3) +  geom_point(aes(x=age_cat, y=low, color="b"), size=3) + geom_point(aes(x=age_cat, y=med, color="c"), size=3) + geom_point(aes(x=age_cat, y=high, colour="d"), size=3) + scale_colour_manual(name = "Rate of partners", values=c("a"="red", "b"="orange", "c"="yellow", "d"="darkgreen"), labels=c("Zero", "Low", "Medium", "High")) + labs(x="Age group", y="Percent", title="Quantile distribution of the rate of instantaneous partners by age group") + theme_title + plot_background 

```

__Decision__: <span style="colour:red"> Fill me in</span>


### Partnership age by respondent age

These plots show the mean partnership age in main and persistent partnerships, respectively, by respondent age.

```{r plotsexplore_pshipage}
#Partnership age by ego age
    pshipage_mainXage <- sample %>% filter(!is.na(pship_age_main)) %>% group_by(age) %>% summarise(freq=n(), mean=mean(pship_age_main))
    ggplot(pshipage_mainXage, aes(x=age, y=mean, size=freq)) + geom_point() + labs(x="Ego age", y="Mean partnership age in days", title = "Mean age of main partnerships by respondent age") 
    
    pshipage_persXage <- sample %>% filter(!is.na(pship_age_pers)) %>% group_by(age) %>% summarise(freq=n(), mean=mean(pship_age_pers))
    ggplot(pshipage_persXage, aes(x=age, y=mean, size=freq)) + geom_point() + labs(x="Ego age", y="Mean partnership age in days", title = "Mean age of persistent partnerships by respondent age") 
    ```
    
### HIV testing by age
The first graph below looks at the proportion of men who report having ever tested by age group. The graph is a bit tricky to interpret because the figure represents both age and cohort effects, and because the number of respondents for some ages is small. It seems that if men don't test by age 40-45, they are unlikely to get tested. The pattern is similar if age is binned in 5 year groups.

```{r plotsexplore_testing}
# Ever tested by age
    evertestedXage <- sample_allages %>%
              filter(!is.na(evertest_r) & !is.na(race_eth_m)) %>%
              group_by(age) %>%
              summarise(prop = mean(evertest_r, na.rm=TRUE), freq=n())
    ggplot(evertestedXage) + geom_point(aes(x=age, y=prop, size=freq)) + geom_smooth(aes(x=age, y=prop), method="loess") + plot_background + theme_title + labs(x="Ego Age", y="Percent ever tested", title="Percent ever tested by age")        


#Intertest interval by age (with calculated mean as implied by exponential distribution)
    itiXage <- sample %>% filter(!is.na(iti) & prep_use_r !="Currently taking PrEP") %>% group_by(age) %>% summarise(freq=n(), median=median(iti, na.rm=TRUE), mean=mean(iti, na.rm=TRUE))
    
    ggplot(itiXage) + geom_point(aes(x=age, y=median, size=freq), colour="blue") + geom_point(aes(x=age, y=mean, size=freq), colour="red") + geom_smooth(aes(x=age, y=median), method="loess") + geom_smooth(aes(x=age, y=mean), method="loess") + labs(x="Ego age", y="Median days since last test", title="Median intertest interval by age, assuming testing is an inteval process")
        
```

### Condom use by age
The plots below show the probability of condom use by respondent age in main partnerships.
```{r plotsexplore_condoms_main}
#Condom use in main partnerships by ego age
   p_condoms_main <- ggplot(sample[!is.na(sample$condoms_main),], aes(x=age, y=condoms_main)) + geom_point() + labs(x="Ego age", y="Probability of condom use", title = "Probability of condom use in main partnerships by respondent age") + plot_background + theme_title
   condoms_mainXage <- sample %>% filter(!is.na(condoms_main)) %>% group_by(age_cat) %>% summarise(freq=n(), mean=mean(condoms_main))
    p_condoms_main_mean <- ggplot(condoms_mainXage, aes(x=age_cat, y=mean, size=freq)) + geom_point() + labs(x="Ego age", y="Mean probability of condom use", title = "Mean probability of condom use in main partnerships by respondent age") + ylim(0, 1)  + plot_background + theme_title
    multiplot(p_condoms_main_mean, p_condoms_main, cols=1)
```
Probability of condom use by respondent age in persistent partnerships:
```{r plotsexplore_condoms_pers}
#Condom use in persistent partnerships by ego age
 p_condoms_pers <- ggplot(sample[!is.na(sample$condoms_pers),], aes(x=age, y=condoms_pers)) + geom_point() + labs(x="Ego age", y="Probability of condom use", title = "Probability of condom use in persistent partnerships by respondent age") + plot_background + theme_title
   condoms_persXage <- sample %>% filter(!is.na(condoms_pers)) %>% group_by(age_cat) %>% summarise(freq=n(), mean=mean(condoms_pers))
    p_condoms_pers_mean <- ggplot(condoms_persXage, aes(x=age_cat, y=mean, size=freq)) + geom_point() + labs(x="Ego age", y="Mean probability of condom use", title = "Mean probability of condom use in persistent partnerships by respondent age") + ylim(0, 1) + plot_background + theme_title
    multiplot(p_condoms_pers_mean, p_condoms_pers, cols=1)
    ```
Probability of condom use in instantaneous partnerships
```{r plotsexplore_condoms_inst}
#Condom use in instantaneous partnerships by ego age
   condoms_instXage <- sample %>% filter(!is.na(condoms_inst)) %>% group_by(age_cat) %>% summarise(freq=n(), mean=mean(condoms_inst))
    ggplot(condoms_instXage, aes(x=age_cat, y=mean, size=freq)) + geom_point() + labs(x="Ego age", y="Mean probability of condom use", title = "Mean probability of condom use in instantaneous partnerships by respondent age") + ylim(0, 1) + plot_background + theme_title
    ```

### PrEP use by age, race, and region
The plots below illustrate the proportion of men for whom local guidelines recommend PrEP who report current use by age, race, and region
```{r plotsexplore_prep_age}
#PrEP use by age
   prepXage <- sample %>% filter(!is.na(prep_use_curr) & prepelig_r %in% "Recommend") %>% group_by(age_cat) %>% summarise(freq=n(), mean=mean(prep_use_curr))
    ggplot(prepXage, aes(x=age_cat, y=mean, size=freq)) + geom_point() + labs(x="Ego age", y="Mean probability of PrEP use", title = "Mean probability of PrEP use among men recommended to initiate PrEP by age") + ylim(0, 1) + plot_background + theme_title
```
    
```{r plotsexplore_prep_race}
#PrEP use by age
   prepXrace <- sample %>% filter(!is.na(prep_use_curr) & prepelig_r %in% "Recommend") %>% group_by(race_eth_m) %>% summarise(freq=n(), mean=mean(prep_use_curr))
    ggplot(prepXrace, aes(x=race_eth_m, y=mean, size=freq)) + geom_point() + labs(x="Ego race/ethnicity", y="Mean probability of PrEP use", title = "Mean probability of PrEP use among men recommended to initiate PrEP by race/ethnicity") + ylim(0, 1) + plot_background + theme_title
```

```{r plotsexplore_prep_region}
#PrEP use by age
   prepXregion <- sample %>% filter(!is.na(prep_use_curr) & prepelig_r %in% "Recommend") %>% group_by(region) %>% summarise(freq=n(), mean=mean(prep_use_curr))
    ggplot(prepXregion, aes(x=region, y=mean, size=freq)) + geom_point() + labs(x="Region", y="Mean probability of PrEP use", title = "Mean probability of PrEP use among men recommended to initiate PrEP by region") + ylim(0, 1) + plot_background + theme_title
```